<!DOCTYPE html>
<html lang="en" data-theme=""><head>
    <title> Moyrne | Kubeadm 搭建K8s集群 </title>

    
    <meta charset="utf-8"><meta name="generator" content="Hugo 0.80.0" /><meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover">
    <meta name="description" content="一个正在成长的菜鸟">
    
    <link rel="stylesheet"
          href="https://blog.moyrn.com/css/style.min.9a6700e4461b50dccdddfc4f81dc65d77e7fca22c35665e398a0c36568db59c7.css"
          integrity="sha256-mmcA5EYbUNzN3fxPgdxl135/yiLDVmXjmKDDZWjbWcc="
          crossorigin="anonymous"
          type="text/css">
    
    <link rel="stylesheet"
        href="https://blog.moyrn.com/css/markupHighlight.min.cc84ed683057cc175ddfa738ea6ba2d5c882b95cb64f50bf9be918cb3791887b.css"
        integrity="sha256-zITtaDBXzBdd36c46mui1ciCuVy2T1C/m&#43;kYyzeRiHs="
        crossorigin="anonymous"
        type="text/css">
    
    <link rel="stylesheet" 
    href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.1/css/all.min.css" 
    integrity="sha512-+4zCK9k+qNFUR5X+cKL9EIR+ZOhtIloNl9GIKS57V1MyNsYpYcUrUeQc9vNfzsWfV28IaLL3i96P9sdNyeRssA==" 
    crossorigin="anonymous" />

    
    <link rel="shortcut icon" href="https://blog.moyrn.com/favicon.ico" type="image/x-icon">
    <link rel="apple-touch-icon" sizes="180x180" href="https://blog.moyrn.com/apple-touch-icon.png">
    <link rel="icon" type="image/png" sizes="32x32" href="https://blog.moyrn.com/favicon-32x32.png">
    <link rel="icon" type="image/png" sizes="16x16" href="https://blog.moyrn.com/favicon-16x16.png">

    <link rel="canonical" href="https://blog.moyrn.com/kubernetes/kubeadm_start/">

    
    
    
    
    <script type="text/javascript"
            src="https://blog.moyrn.com/js/anatole-header.min.d8599ee07b7d3f11bafbac30657ccc591e8d7fd36a9f580cd4c09e24e0e4a971.js"
            integrity="sha256-2Fme4Ht9PxG6&#43;6wwZXzMWR6Nf9Nqn1gM1MCeJODkqXE="
            crossorigin="anonymous"></script>


    
        
        
        <script type="text/javascript"
                src="https://blog.moyrn.com/js/anatole-theme-switcher.min.e289e9ebb2a4e7a7f895859c8a2b0da2de1ec73f22cea58d8475aa0597023837.js"
                integrity="sha256-4onp67Kk56f4lYWciisNot4exz8izqWNhHWqBZcCODc="
                crossorigin="anonymous"></script>
    
    <meta name="twitter:card" content="summary"/>
<meta name="twitter:title" content="Kubeadm 搭建K8s集群"/>
<meta name="twitter:description" content="前置操作 (每台机器上都需要操作)  使用系统 Centos 7  cat /etc/redhat-release CentOS Linux release 7.9.2009 (Core)  关闭防火墙  systemctl stop firewalld &amp;&amp; systemctl disable firewalld  禁用SELINUX  vim /etc/selinux/config # 或者修改/etc/sysconfig/selinux SELINUX=disabled  修改 k8s.conf  cat &lt;&lt;EOF &gt; /etc/sysctl.d/k8s.conf net.bridge.bridge-nf-call-ip6tables = 1 net.bridge.bridge-nf-call-iptables = 1 EOF sysctl --system  关闭 swap  swapoff -a vim /etc/fstab # 注释掉以下字段 /dev/mapper/cl-swap swap swap defaults 0 0 reboot  使用yum安装 docker-ce docker-ce-selinux  # step 1: 安装必要的一些系统工具 sudo yum install -y yum-utils device-mapper-persistent-data lvm2 # Step 2: 添加软件源信息 sudo yum-config-manager --add-repo http://mirrors."/>

</head>
<body><div class="sidebar animated fadeInDown ">
    <div class="logo-title">
        <div class="title">
            <img src="https://blog.moyrn.com/images/profile.jpg" alt="profile picture">
            <h3 title=""><a href="/">Moyrne</a></h3>
            <div class="description">
                <p>一个正在成长的菜鸟</p>
            </div>
        </div>
    </div>
    <ul class="social-links">
        
    </ul>
    <div class="footer">
        <div class="by_farbox">&copy; Moyrne  2021 </div>
    </div>
</div>
<div class="main">
    <div class="page-top  animated fadeInDown ">
    <a role="button" class="navbar-burger" data-target="navMenu" aria-label="menu" aria-expanded="false">
        <span aria-hidden="true"></span>
        <span aria-hidden="true"></span>
        <span aria-hidden="true"></span>
    </a>
    <ul class="nav" id="navMenu">
        
        
            
            <li><a 
                   href="/"
                        
                   title="">主页</a></li>
        
            
            <li><a 
                   href="/kubernetes/"
                        
                   title="">Kubernetes</a></li>
        
            
            <li><a 
                   href="/golang/"
                        
                   title="">Golang</a></li>
        
            
            <li><a 
                   href="/tools/"
                        
                   title="">实用工具</a></li>
        
            
            <li><a 
                   href="/about"
                        
                   title="">关于我</a></li>
        
        
        
            <li class="theme-switch-item">
                <a class="theme-switch" title="Switch Theme">
                    <i class="fas fa-adjust fa-fw" aria-hidden="true"></i>
                </a>
            </li>
        
    </ul>
</div>

    <div class="autopagerize_page_element">
        <div class="content">
    <div class="post  animated fadeInDown ">
        <div class="post-content">
            
            <div class="post-title">
                <h3>Kubeadm 搭建K8s集群</h3>
                
            </div>

            <h2 id="前置操作-每台机器上都需要操作">前置操作 (每台机器上都需要操作)</h2>
<ul>
<li>使用系统 Centos 7</li>
</ul>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-shell" data-lang="shell">cat /etc/redhat-release
CentOS Linux release 7.9.2009 <span style="color:#f92672">(</span>Core<span style="color:#f92672">)</span>
</code></pre></div><ul>
<li>关闭防火墙</li>
</ul>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-shell" data-lang="shell">systemctl stop firewalld <span style="color:#f92672">&amp;&amp;</span> systemctl disable firewalld
</code></pre></div><ul>
<li>禁用SELINUX</li>
</ul>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-shell" data-lang="shell">vim /etc/selinux/config
</code></pre></div><div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-text" data-lang="text"># 或者修改/etc/sysconfig/selinux
SELINUX=disabled
</code></pre></div><ul>
<li>修改 k8s.conf</li>
</ul>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-shell" data-lang="shell">cat <span style="color:#e6db74">&lt;&lt;EOF &gt;  /etc/sysctl.d/k8s.conf
</span><span style="color:#e6db74">net.bridge.bridge-nf-call-ip6tables = 1
</span><span style="color:#e6db74">net.bridge.bridge-nf-call-iptables = 1
</span><span style="color:#e6db74">EOF</span>
sysctl --system
</code></pre></div><ul>
<li>关闭 swap</li>
</ul>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-shell" data-lang="shell">swapoff -a
vim /etc/fstab
</code></pre></div><div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-text" data-lang="text"># 注释掉以下字段
/dev/mapper/cl-swap     swap                    swap    defaults        0 0
</code></pre></div><div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-shell" data-lang="shell">reboot
</code></pre></div><ul>
<li>使用yum安装 <code>docker-ce</code> <code>docker-ce-selinux</code></li>
</ul>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-shell" data-lang="shell"><span style="color:#75715e"># step 1: 安装必要的一些系统工具</span>
sudo yum install -y yum-utils device-mapper-persistent-data lvm2
<span style="color:#75715e"># Step 2: 添加软件源信息</span>
sudo yum-config-manager --add-repo http://mirrors.aliyun.com/docker-ce/linux/centos/docker-ce.repo
<span style="color:#75715e"># Step 3: 查看可安装的 docker-ce 版本</span>
yum list docker-ce.x86_64 --showduplicates | sort -r
<span style="color:#75715e"># Step 4 : 安装指定版本的Docker-CE</span>
sudo yum -y --setopt<span style="color:#f92672">=</span>obsoletes<span style="color:#f92672">=</span><span style="color:#ae81ff">0</span> install docker-ce-<span style="color:#f92672">[</span>VERSION<span style="color:#f92672">]</span> docker-ce-selinux-<span style="color:#f92672">[</span>VERSION<span style="color:#f92672">]</span>
<span style="color:#75715e"># Step 5: 开启Docker服务</span>
sudo systemctl enable docker <span style="color:#f92672">&amp;&amp;</span> systemctl start docker
</code></pre></div><ul>
<li>安装成功后验证</li>
</ul>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-shell" data-lang="shell">docker version
</code></pre></div><div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-text" data-lang="text">Client: Docker Engine - Community
 Version:           20.10.3
 API version:       1.40
 Go version:        go1.13.15
 Git commit:        48d30b5
 Built:             Fri Jan 29 14:34:14 2021
 OS/Arch:           linux/amd64
 Context:           default
 Experimental:      true

Server: Docker Engine - Community
 Engine:
  Version:          19.03.10
  API version:      1.40 (minimum version 1.12)
  Go version:       go1.13.10
  Git commit:       9424aeaee9
  Built:            Thu May 28 22:16:43 2020
  OS/Arch:          linux/amd64
  Experimental:     false
 containerd:
  Version:          1.4.3
  GitCommit:        269548fa27e0089a8b8278fc4fc781d7f65a939b
 runc:
  Version:          1.0.0-rc92
  GitCommit:        ff819c7e9184c13b7c2607fe6c30ae19403a7aff
 docker-init:
  Version:          0.18.0
  GitCommit:        fec3683
</code></pre></div><h2 id="安装kubeadmkubeletkubectl">安装kubeadm，kubelet，kubectl</h2>
<ul>
<li>修改 yum 源</li>
</ul>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-shell" data-lang="shell">cat <span style="color:#e6db74">&lt;&lt;EOF &gt; /etc/yum.repos.d/kubernetes.repo
</span><span style="color:#e6db74">[kubernetes]
</span><span style="color:#e6db74">name=Kubernetes
</span><span style="color:#e6db74">baseurl=https://mirrors.aliyun.com/kubernetes/yum/repos/kubernetes-el7-x86_64/
</span><span style="color:#e6db74">enabled=1
</span><span style="color:#e6db74">gpgcheck=1
</span><span style="color:#e6db74">repo_gpgcheck=1
</span><span style="color:#e6db74">gpgkey=https://mirrors.aliyun.com/kubernetes/yum/doc/yum-key.gpg https://mirrors.aliyun.com/kubernetes/yum/doc/rpm-package-key.gpg
</span><span style="color:#e6db74">EOF</span>
</code></pre></div><ul>
<li>安装 <code>kubelet</code> <code>kubeadm</code> <code>kubectl</code></li>
</ul>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-shell" data-lang="shell">yum install -y kubelet kubeadm kubectl
systemctl enable kubelet <span style="color:#f92672">&amp;&amp;</span> systemctl start kubelet
</code></pre></div><ul>
<li>创建 kubeadm init 初始化文件 (仅master)</li>
</ul>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-shell" data-lang="shell">vim kubeadm-init.yaml
</code></pre></div><div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-yaml" data-lang="yaml"><span style="color:#f92672">apiVersion</span>: <span style="color:#ae81ff">kubeadm.k8s.io/v1beta2</span>
<span style="color:#f92672">kind</span>: <span style="color:#ae81ff">ClusterConfiguration</span>
<span style="color:#f92672">kubernetesVersion</span>: <span style="color:#ae81ff">v1.20.0</span>
<span style="color:#f92672">imageRepository</span>: <span style="color:#ae81ff">registry.aliyuncs.com/k8sxio</span>
<span style="color:#f92672">controlPlaneEndpoint</span>: <span style="color:#e6db74">&#34;192.168.111.128:6443&#34;</span>
<span style="color:#f92672">networking</span>:
  <span style="color:#f92672">serviceSubnet</span>: <span style="color:#e6db74">&#34;10.96.0.0/16&#34;</span>
  <span style="color:#f92672">podSubnet</span>: <span style="color:#e6db74">&#34;10.100.0.1/16&#34;</span>
  <span style="color:#f92672">dnsDomain</span>: <span style="color:#e6db74">&#34;192.168.111.128&#34;</span>
</code></pre></div><ul>
<li>初始化 (仅master)</li>
</ul>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-shell" data-lang="shell">kubeadm init --config kubeadm-init.yaml
</code></pre></div><div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-shell" data-lang="shell"><span style="color:#75715e"># 初始化完成后，会有以下提示出现</span>
kubeadm join --token &lt;token&gt; &lt;master-ip&gt;:&lt;master-port&gt; --discovery-token-ca-cert-hash sha256:&lt;hash&gt;
</code></pre></div><ul>
<li>配置 kubectl (仅master), node上需要使用时，需要拷贝 config 文件</li>
</ul>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-shell" data-lang="shell">mkdir -p ~/.kube
sudo cp -i /etc/kubernetes/admin.conf ~/.kube/config
sudo chown <span style="color:#66d9ef">$(</span>id -u<span style="color:#66d9ef">)</span>:<span style="color:#66d9ef">$(</span>id -g<span style="color:#66d9ef">)</span> ~/.kube/config
</code></pre></div><ul>
<li>[警告] 当配置错误时可以使用</li>
</ul>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-shell" data-lang="shell">kubeadm reset
</code></pre></div><ul>
<li>安装Pod Network</li>
</ul>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-text" data-lang="text"># 比较知名的网络解决方案:
flannel
calico
canel
kube-router
.......
</code></pre></div><div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-shell" data-lang="shell"><span style="color:#75715e"># 下载 至 本地</span>
wget https://raw.githubusercontent.com/coreos/flannel/master/Documentation/kube-flannel.yml
<span style="color:#75715e"># 如果打不开也可以自行复制 https://github.com/coreos/flannel/blob/master/Documentation/kube-flannel.yml</span>
kubectl apply -f kube-flannel.yml
</code></pre></div><ul>
<li>查看当前 Pod 状态</li>
</ul>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-shell" data-lang="shell">kubectl get pod -A -o wide
</code></pre></div><ul>
<li>在 node 上执行 kubeadm init 完成时提示的命令</li>
</ul>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-shell" data-lang="shell">kubeadm join --token &lt;token&gt; &lt;master-ip&gt;:&lt;master-port&gt; --discovery-token-ca-cert-hash sha256:&lt;hash&gt;
</code></pre></div><ul>
<li>再次查看当前 Pod 状态</li>
</ul>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-shell" data-lang="shell"><span style="color:#75715e"># -A == -all-namespace</span>
kubectl get pod -A -o wide
</code></pre></div><div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-text" data-lang="text">NAMESPACE     NAME                             READY   STATUS    RESTARTS   AGE   IP                NODE     NOMINATED NODE   READINESS GATES
kube-system   coredns-68b9d7b887-2pswd         1/1     Running   1          22h   10.100.0.5        master   &lt;none&gt;           &lt;none&gt;
kube-system   coredns-68b9d7b887-7t42s         1/1     Running   1          22h   10.100.0.4        master   &lt;none&gt;           &lt;none&gt;
kube-system   etcd-master                      1/1     Running   1          22h   192.168.111.128   master   &lt;none&gt;           &lt;none&gt;
kube-system   kube-apiserver-master            1/1     Running   1          22h   192.168.111.128   master   &lt;none&gt;           &lt;none&gt;
kube-system   kube-controller-manager-master   1/1     Running   1          22h   192.168.111.128   master   &lt;none&gt;           &lt;none&gt;
kube-system   kube-flannel-ds-5h8jr            1/1     Running   1          22h   192.168.111.130   node2    &lt;none&gt;           &lt;none&gt;
kube-system   kube-flannel-ds-gzzhz            1/1     Running   1          22h   192.168.111.128   master   &lt;none&gt;           &lt;none&gt;
kube-system   kube-flannel-ds-pxh9j            1/1     Running   7          22h   192.168.111.129   node1    &lt;none&gt;           &lt;none&gt;
kube-system   kube-proxy-cxphf                 1/1     Running   1          22h   192.168.111.130   node2    &lt;none&gt;           &lt;none&gt;
kube-system   kube-proxy-hzh4k                 1/1     Running   1          22h   192.168.111.129   node1    &lt;none&gt;           &lt;none&gt;
kube-system   kube-proxy-kktrf                 1/1     Running   1          22h   192.168.111.128   master   &lt;none&gt;           &lt;none&gt;
kube-system   kube-scheduler-master            1/1     Running   1          22h   192.168.111.128   master   &lt;none&gt;           &lt;none&gt;
</code></pre></div></div>
        <div class="post-footer">
            <div class="info">
                
                
            </div>
        </div>

        
    </div>


        </div>
    </div>
</div>

<script type="text/javascript"
        src="https://blog.moyrn.com/js/jquery.min.86b1e8f819ee2d9099a783e50b49dff24282545fc40773861f9126b921532e4c.js"
        integrity="sha256-hrHo&#43;BnuLZCZp4PlC0nf8kKCVF/EB3OGH5EmuSFTLkw="
        crossorigin="anonymous"></script>




<script type="text/javascript"
        src="https://blog.moyrn.com/js/bundle.min.0f9c74cb78f13d1f15f33daff4037c70354f98acfbb97a6f61708966675c3cae.js"
        integrity="sha256-D5x0y3jxPR8V8z2v9AN8cDVPmKz7uXpvYXCJZmdcPK4="
        crossorigin="anonymous"></script>

<script type="text/javascript"
        src="https://blog.moyrn.com/js/medium-zoom.min.92f21c856129f84aeb719459b3e6ac621a3032fd7b180a18c04e1d12083f8aba.js"
        integrity="sha256-kvIchWEp&#43;ErrcZRZs&#43;asYhowMv17GAoYwE4dEgg/iro="
        crossorigin="anonymous"></script>
</body>

</html>
