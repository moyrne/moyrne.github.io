<!doctype html><html lang=zh dir=auto><head><meta charset=utf-8><meta http-equiv=X-UA-Compatible content="IE=edge"><meta name=viewport content="width=device-width,initial-scale=1,shrink-to-fit=no"><meta name=robots content="index, follow"><title>Kubeadm 搭建K8s集群 | Moyrne'Blog</title>
<meta name=keywords content="kubernetes"><meta name=description content='前置操作 (每台机器上都需要操作) 使用系统 Centos 7 cat /etc/redhat-release CentOS Linux release 7.9.2009 (Core) 关闭防火墙 systemctl stop firewalld && systemctl disable firewalld 禁用SELINUX vim /etc/selinux/config # 或者修改/etc/sysconfig/selinux SELINUX=disabled [注意] 开启 IP 路由转发和 NAT # https://ccie.lol/knowledge-base/linux-centos-route-forwarding/ # 不开启会导致 Pod 无法链接外网以及 Pod 间无法通信的问题. [root@host ~]# echo "net.ipv4.ip_forward = 1" >> /etc/sysctl.conf [root@host ~]# sysctl -p [root@host ~]# sysctl -a | grep "ip_forward" net.ipv4.ip_forward = 1 # 开启NAT [root@host ~]# iptables -P FORWARD ACCEPT # 缺省允许 IP 转发 # 利用 iptables 实现 NAT MASQUERADE 共享上网，此处 eth0 需要是能够访问外部网络的网卡接口 [root@host ~]# iptables -t nat -A POSTROUTING -o eth0 -j MASQUERADE 修改 k8s.'><meta name=author content><link rel=canonical href=https://blog.moyrn.com/posts/20210207_kubeadm_start/><meta name=msvalidate.01 content="XYZabc"><link crossorigin=anonymous href=/assets/css/stylesheet.f49d66caae9ea0fd43f21f29e71a8d3e284517ed770f2aa86fa012953ad3c9ef.css integrity="sha256-9J1myq6eoP1D8h8p5xqNPihFF+13Dyqob6ASlTrTye8=" rel="preload stylesheet" as=style><link rel=icon href=https://blog.moyrn.com/favicon.ico><link rel=icon type=image/png sizes=16x16 href=https://blog.moyrn.com/favicon.ico><link rel=icon type=image/png sizes=32x32 href=https://blog.moyrn.com/favicon.ico><link rel=apple-touch-icon href=https://blog.moyrn.com/favicon.ico><link rel=mask-icon href=https://blog.moyrn.com/favicon.ico><meta name=theme-color content="#2e2e33"><meta name=msapplication-TileColor content="#2e2e33"><link rel=alternate hreflang=zh href=https://blog.moyrn.com/posts/20210207_kubeadm_start/><noscript><style>#theme-toggle,.top-link{display:none}</style><style>@media(prefers-color-scheme:dark){:root{--theme:rgb(29, 30, 32);--entry:rgb(46, 46, 51);--primary:rgb(218, 218, 219);--secondary:rgb(155, 156, 157);--tertiary:rgb(65, 66, 68);--content:rgb(196, 196, 197);--code-block-bg:rgb(46, 46, 51);--code-bg:rgb(55, 56, 62);--border:rgb(51, 51, 51)}.list{background:var(--theme)}.list:not(.dark)::-webkit-scrollbar-track{background:0 0}.list:not(.dark)::-webkit-scrollbar-thumb{border-color:var(--theme)}}</style></noscript><meta property="og:url" content="https://blog.moyrn.com/posts/20210207_kubeadm_start/"><meta property="og:site_name" content="Moyrne'Blog"><meta property="og:title" content="Kubeadm 搭建K8s集群"><meta property="og:description" content='前置操作 (每台机器上都需要操作) 使用系统 Centos 7 cat /etc/redhat-release CentOS Linux release 7.9.2009 (Core) 关闭防火墙 systemctl stop firewalld && systemctl disable firewalld 禁用SELINUX vim /etc/selinux/config # 或者修改/etc/sysconfig/selinux SELINUX=disabled [注意] 开启 IP 路由转发和 NAT # https://ccie.lol/knowledge-base/linux-centos-route-forwarding/ # 不开启会导致 Pod 无法链接外网以及 Pod 间无法通信的问题. [root@host ~]# echo "net.ipv4.ip_forward = 1" >> /etc/sysctl.conf [root@host ~]# sysctl -p [root@host ~]# sysctl -a | grep "ip_forward" net.ipv4.ip_forward = 1 # 开启NAT [root@host ~]# iptables -P FORWARD ACCEPT # 缺省允许 IP 转发 # 利用 iptables 实现 NAT MASQUERADE 共享上网，此处 eth0 需要是能够访问外部网络的网卡接口 [root@host ~]# iptables -t nat -A POSTROUTING -o eth0 -j MASQUERADE 修改 k8s.'><meta property="og:locale" content="zh-CN"><meta property="og:type" content="article"><meta property="article:section" content="posts"><meta property="article:published_time" content="2021-02-07T13:56:54+08:00"><meta property="article:modified_time" content="2021-02-07T13:56:54+08:00"><meta property="article:tag" content="Kubernetes"><meta name=twitter:card content="summary"><meta name=twitter:title content="Kubeadm 搭建K8s集群"><meta name=twitter:description content='前置操作 (每台机器上都需要操作) 使用系统 Centos 7 cat /etc/redhat-release CentOS Linux release 7.9.2009 (Core) 关闭防火墙 systemctl stop firewalld && systemctl disable firewalld 禁用SELINUX vim /etc/selinux/config # 或者修改/etc/sysconfig/selinux SELINUX=disabled [注意] 开启 IP 路由转发和 NAT # https://ccie.lol/knowledge-base/linux-centos-route-forwarding/ # 不开启会导致 Pod 无法链接外网以及 Pod 间无法通信的问题. [root@host ~]# echo "net.ipv4.ip_forward = 1" >> /etc/sysctl.conf [root@host ~]# sysctl -p [root@host ~]# sysctl -a | grep "ip_forward" net.ipv4.ip_forward = 1 # 开启NAT [root@host ~]# iptables -P FORWARD ACCEPT # 缺省允许 IP 转发 # 利用 iptables 实现 NAT MASQUERADE 共享上网，此处 eth0 需要是能够访问外部网络的网卡接口 [root@host ~]# iptables -t nat -A POSTROUTING -o eth0 -j MASQUERADE 修改 k8s.'><script type=application/ld+json>{"@context":"https://schema.org","@type":"BreadcrumbList","itemListElement":[{"@type":"ListItem","position":1,"name":"Posts","item":"https://blog.moyrn.com/posts/"},{"@type":"ListItem","position":2,"name":"Kubeadm 搭建K8s集群","item":"https://blog.moyrn.com/posts/20210207_kubeadm_start/"}]}</script><script type=application/ld+json>{"@context":"https://schema.org","@type":"BlogPosting","headline":"Kubeadm 搭建K8s集群","name":"Kubeadm 搭建K8s集群","description":"前置操作 (每台机器上都需要操作) 使用系统 Centos 7 cat /etc/redhat-release CentOS Linux release 7.9.2009 (Core) 关闭防火墙 systemctl stop firewalld \u0026amp;\u0026amp; systemctl disable firewalld 禁用SELINUX vim /etc/selinux/config # 或者修改/etc/sysconfig/selinux SELINUX=disabled [注意] 开启 IP 路由转发和 NAT # https://ccie.lol/knowledge-base/linux-centos-route-forwarding/ # 不开启会导致 Pod 无法链接外网以及 Pod 间无法通信的问题. [root@host ~]# echo \u0026#34;net.ipv4.ip_forward = 1\u0026#34; \u0026gt;\u0026gt; /etc/sysctl.conf [root@host ~]# sysctl -p [root@host ~]# sysctl -a | grep \u0026#34;ip_forward\u0026#34; net.ipv4.ip_forward = 1 # 开启NAT [root@host ~]# iptables -P FORWARD ACCEPT # 缺省允许 IP 转发 # 利用 iptables 实现 NAT MASQUERADE 共享上网，此处 eth0 需要是能够访问外部网络的网卡接口 [root@host ~]# iptables -t nat -A POSTROUTING -o eth0 -j MASQUERADE 修改 k8s.","keywords":["kubernetes"],"articleBody":"前置操作 (每台机器上都需要操作) 使用系统 Centos 7 cat /etc/redhat-release CentOS Linux release 7.9.2009 (Core) 关闭防火墙 systemctl stop firewalld \u0026\u0026 systemctl disable firewalld 禁用SELINUX vim /etc/selinux/config # 或者修改/etc/sysconfig/selinux SELINUX=disabled [注意] 开启 IP 路由转发和 NAT # https://ccie.lol/knowledge-base/linux-centos-route-forwarding/ # 不开启会导致 Pod 无法链接外网以及 Pod 间无法通信的问题. [root@host ~]# echo \"net.ipv4.ip_forward = 1\" \u003e\u003e /etc/sysctl.conf [root@host ~]# sysctl -p [root@host ~]# sysctl -a | grep \"ip_forward\" net.ipv4.ip_forward = 1 # 开启NAT [root@host ~]# iptables -P FORWARD ACCEPT # 缺省允许 IP 转发 # 利用 iptables 实现 NAT MASQUERADE 共享上网，此处 eth0 需要是能够访问外部网络的网卡接口 [root@host ~]# iptables -t nat -A POSTROUTING -o eth0 -j MASQUERADE 修改 k8s.conf cat \u003c /etc/sysctl.d/k8s.conf net.bridge.bridge-nf-call-ip6tables = 1 net.bridge.bridge-nf-call-iptables = 1 EOF sysctl --system 关闭 swap swapoff -a vim /etc/fstab # 注释掉以下字段 /dev/mapper/cl-swap swap swap defaults 0 0 reboot 使用yum安装 docker-ce docker-ce-selinux # step 1: 安装必要的一些系统工具 sudo yum install -y yum-utils device-mapper-persistent-data lvm2 # Step 2: 添加软件源信息 sudo yum-config-manager --add-repo http://mirrors.aliyun.com/docker-ce/linux/centos/docker-ce.repo # Step 3: 查看可安装的 docker-ce 版本 yum list docker-ce.x86_64 --showduplicates | sort -r # Step 4 : 安装指定版本的Docker-CE sudo yum -y --setopt=obsoletes=0 install docker-ce-[VERSION] docker-ce-selinux-[VERSION] # Step 5: 开启Docker服务 sudo systemctl enable docker \u0026\u0026 systemctl start docker 安装成功后验证 docker version Client: Docker Engine - Community Version: 20.10.3 API version: 1.40 Go version: go1.13.15 Git commit: 48d30b5 Built: Fri Jan 29 14:34:14 2021 OS/Arch: linux/amd64 Context: default Experimental: true Server: Docker Engine - Community Engine: Version: 19.03.10 API version: 1.40 (minimum version 1.12) Go version: go1.13.10 Git commit: 9424aeaee9 Built: Thu May 28 22:16:43 2020 OS/Arch: linux/amd64 Experimental: false containerd: Version: 1.4.3 GitCommit: 269548fa27e0089a8b8278fc4fc781d7f65a939b runc: Version: 1.0.0-rc92 GitCommit: ff819c7e9184c13b7c2607fe6c30ae19403a7aff docker-init: Version: 0.18.0 GitCommit: fec3683 安装kubeadm，kubelet，kubectl 修改 yum 源 cat \u003c /etc/yum.repos.d/kubernetes.repo [kubernetes] name=Kubernetes baseurl=https://mirrors.aliyun.com/kubernetes/yum/repos/kubernetes-el7-x86_64/ enabled=1 gpgcheck=1 repo_gpgcheck=1 gpgkey=https://mirrors.aliyun.com/kubernetes/yum/doc/yum-key.gpg https://mirrors.aliyun.com/kubernetes/yum/doc/rpm-package-key.gpg EOF 安装 kubelet kubeadm kubectl yum install -y kubelet kubeadm kubectl systemctl enable kubelet \u0026\u0026 systemctl start kubelet 创建 kubeadm init 初始化文件 (仅master) vim kubeadm-init.yaml apiVersion: kubeadm.k8s.io/v1beta2 kind: ClusterConfiguration kubernetesVersion: v1.20.0 imageRepository: registry.aliyuncs.com/k8sxio controlPlaneEndpoint: \"192.168.111.128:6443\" networking: serviceSubnet: \"10.96.0.0/16\" podSubnet: \"10.100.0.1/16\" dnsDomain: \"192.168.111.128\" 初始化 (仅master) kubeadm init --config kubeadm-init.yaml # 初始化完成后，会有以下提示出现 kubeadm join --token : --discovery-token-ca-cert-hash sha256: 配置 kubectl (仅master), node上需要使用时，需要拷贝 config 文件 mkdir -p ~/.kube sudo cp -i /etc/kubernetes/admin.conf ~/.kube/config sudo chown $(id -u):$(id -g) ~/.kube/config [警告] 当配置错误时可以使用 kubeadm reset 安装Pod Network # 比较知名的网络解决方案: flannel calico canel kube-router weave ....... flannel\n[*] flannel 如果需要跨主机修改配置信息 host-gw net-conf.json: | { \"Network\": \"10.244.0.0/16\", \"Backend\": { \"Type\": \"host-gw\" } } vxlan 要打开直接路由转发方式 net-conf.json: | { \"Network\": \"10.244.0.0/16\", \"Backend\": { \"Type\": \"vxlan\", \"Directrouting\": true } } # 下载 至 本地 wget https://raw.githubusercontent.com/coreos/flannel/master/Documentation/kube-flannel.yml # 如果打不开也可以自行复制 https://github.com/coreos/flannel/blob/master/Documentation/kube-flannel.yml kubectl apply -f kube-flannel.yml weave kubectl apply -f \"https://cloud.weave.works/k8s/net?k8s-version=$(kubectl version | base64 | tr -d '\\n')\" kubeadm config print init-defaults 查看当前 Pod 状态 kubectl get pod -A -o wide 在 node 上执行 kubeadm init 完成时提示的命令 kubeadm join --token : --discovery-token-ca-cert-hash sha256: 再次查看当前 Pod 状态 # -A == -all-namespace kubectl get pod -A -o wide NAMESPACE NAME READY STATUS RESTARTS AGE IP NODE NOMINATED NODE READINESS GATES kube-system coredns-68b9d7b887-2pswd 1/1 Running 1 22h 10.100.0.5 master kube-system coredns-68b9d7b887-7t42s 1/1 Running 1 22h 10.100.0.4 master kube-system etcd-master 1/1 Running 1 22h 192.168.111.128 master kube-system kube-apiserver-master 1/1 Running 1 22h 192.168.111.128 master kube-system kube-controller-manager-master 1/1 Running 1 22h 192.168.111.128 master kube-system kube-flannel-ds-5h8jr 1/1 Running 1 22h 192.168.111.130 node2 kube-system kube-flannel-ds-gzzhz 1/1 Running 1 22h 192.168.111.128 master kube-system kube-flannel-ds-pxh9j 1/1 Running 7 22h 192.168.111.129 node1 kube-system kube-proxy-cxphf 1/1 Running 1 22h 192.168.111.130 node2 kube-system kube-proxy-hzh4k 1/1 Running 1 22h 192.168.111.129 node1 kube-system kube-proxy-kktrf 1/1 Running 1 22h 192.168.111.128 master kube-system kube-scheduler-master 1/1 Running 1 22h 192.168.111.128 master ","wordCount":"592","inLanguage":"zh","datePublished":"2021-02-07T13:56:54+08:00","dateModified":"2021-02-07T13:56:54+08:00","mainEntityOfPage":{"@type":"WebPage","@id":"https://blog.moyrn.com/posts/20210207_kubeadm_start/"},"publisher":{"@type":"Organization","name":"Moyrne'Blog","logo":{"@type":"ImageObject","url":"https://blog.moyrn.com/favicon.ico"}}}</script></head><body id=top><script>localStorage.getItem("pref-theme")==="dark"?document.body.classList.add("dark"):localStorage.getItem("pref-theme")==="light"?document.body.classList.remove("dark"):window.matchMedia("(prefers-color-scheme: dark)").matches&&document.body.classList.add("dark")</script><header class=header><nav class=nav><div class=logo><a href=https://blog.moyrn.com/ accesskey=h title="Home (Alt + H)">Home</a><div class=logo-switches><button id=theme-toggle accesskey=t title="(Alt + T)" aria-label="Toggle theme"><svg id="moon" xmlns="http://www.w3.org/2000/svg" width="24" height="18" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 12.79A9 9 0 1111.21 3 7 7 0 0021 12.79z"/></svg><svg id="sun" xmlns="http://www.w3.org/2000/svg" width="24" height="18" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="5"/><line x1="12" y1="1" x2="12" y2="3"/><line x1="12" y1="21" x2="12" y2="23"/><line x1="4.22" y1="4.22" x2="5.64" y2="5.64"/><line x1="18.36" y1="18.36" x2="19.78" y2="19.78"/><line x1="1" y1="12" x2="3" y2="12"/><line x1="21" y1="12" x2="23" y2="12"/><line x1="4.22" y1="19.78" x2="5.64" y2="18.36"/><line x1="18.36" y1="5.64" x2="19.78" y2="4.22"/></svg></button></div></div><ul id=menu><li><a href=https://blog.moyrn.com/tags/ title=Tags><span>Tags</span></a></li><li><a href=https://blog.moyrn.com/categories/ title=Categories><span>Categories</span></a></li></ul></nav></header><main class=main><article class=post-single><header class=post-header><div class=breadcrumbs><a href=https://blog.moyrn.com/>主页</a>&nbsp;»&nbsp;<a href=https://blog.moyrn.com/posts/>Posts</a></div><h1 class="post-title entry-hint-parent">Kubeadm 搭建K8s集群</h1><div class=post-meta><span title='2021-02-07 13:56:54 +0800 CST'>2021-02-07</span>&nbsp;·&nbsp;3 分钟&nbsp;·&nbsp;592 字</div></header><div class=post-content><h2 id=前置操作-每台机器上都需要操作>前置操作 (每台机器上都需要操作)<a hidden class=anchor aria-hidden=true href=#前置操作-每台机器上都需要操作>#</a></h2><ul><li>使用系统 Centos 7</li></ul><div class=highlight><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell><span class=line><span class=cl>cat /etc/redhat-release
</span></span><span class=line><span class=cl>CentOS Linux release 7.9.2009 <span class=o>(</span>Core<span class=o>)</span>
</span></span></code></pre></div><ul><li>关闭防火墙</li></ul><div class=highlight><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell><span class=line><span class=cl>systemctl stop firewalld <span class=o>&amp;&amp;</span> systemctl disable firewalld
</span></span></code></pre></div><ul><li>禁用SELINUX</li></ul><div class=highlight><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell><span class=line><span class=cl>vim /etc/selinux/config
</span></span></code></pre></div><div class=highlight><pre tabindex=0 class=chroma><code class=language-text data-lang=text><span class=line><span class=cl># 或者修改/etc/sysconfig/selinux
</span></span><span class=line><span class=cl>SELINUX=disabled
</span></span></code></pre></div><ul><li>[注意] 开启 IP 路由转发和 NAT</li></ul><div class=highlight><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell><span class=line><span class=cl><span class=c1># https://ccie.lol/knowledge-base/linux-centos-route-forwarding/</span>
</span></span><span class=line><span class=cl><span class=c1># 不开启会导致 Pod 无法链接外网以及 Pod 间无法通信的问题.</span>
</span></span><span class=line><span class=cl><span class=o>[</span>root@host ~<span class=o>]</span><span class=c1># echo &#34;net.ipv4.ip_forward = 1&#34; &gt;&gt; /etc/sysctl.conf</span>
</span></span><span class=line><span class=cl><span class=o>[</span>root@host ~<span class=o>]</span><span class=c1># sysctl -p</span>
</span></span><span class=line><span class=cl><span class=o>[</span>root@host ~<span class=o>]</span><span class=c1># sysctl -a | grep &#34;ip_forward&#34;</span>
</span></span><span class=line><span class=cl>net.ipv4.ip_forward <span class=o>=</span> <span class=m>1</span>
</span></span><span class=line><span class=cl><span class=c1># 开启NAT</span>
</span></span><span class=line><span class=cl><span class=o>[</span>root@host ~<span class=o>]</span><span class=c1># iptables -P FORWARD ACCEPT    # 缺省允许 IP 转发</span>
</span></span><span class=line><span class=cl><span class=c1># 利用 iptables 实现 NAT MASQUERADE 共享上网，此处 eth0 需要是能够访问外部网络的网卡接口</span>
</span></span><span class=line><span class=cl><span class=o>[</span>root@host ~<span class=o>]</span><span class=c1># iptables -t nat -A POSTROUTING -o eth0 -j MASQUERADE</span>
</span></span></code></pre></div><ul><li>修改 k8s.conf</li></ul><div class=highlight><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell><span class=line><span class=cl>cat <span class=s>&lt;&lt;EOF &gt;  /etc/sysctl.d/k8s.conf
</span></span></span><span class=line><span class=cl><span class=s>net.bridge.bridge-nf-call-ip6tables = 1
</span></span></span><span class=line><span class=cl><span class=s>net.bridge.bridge-nf-call-iptables = 1
</span></span></span><span class=line><span class=cl><span class=s>EOF</span>
</span></span><span class=line><span class=cl>sysctl --system
</span></span></code></pre></div><ul><li>关闭 swap</li></ul><div class=highlight><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell><span class=line><span class=cl>swapoff -a
</span></span><span class=line><span class=cl>vim /etc/fstab
</span></span></code></pre></div><div class=highlight><pre tabindex=0 class=chroma><code class=language-text data-lang=text><span class=line><span class=cl># 注释掉以下字段
</span></span><span class=line><span class=cl>/dev/mapper/cl-swap     swap                    swap    defaults        0 0
</span></span></code></pre></div><div class=highlight><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell><span class=line><span class=cl>reboot
</span></span></code></pre></div><ul><li>使用yum安装 <code>docker-ce</code> <code>docker-ce-selinux</code></li></ul><div class=highlight><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell><span class=line><span class=cl><span class=c1># step 1: 安装必要的一些系统工具</span>
</span></span><span class=line><span class=cl>sudo yum install -y yum-utils device-mapper-persistent-data lvm2
</span></span><span class=line><span class=cl><span class=c1># Step 2: 添加软件源信息</span>
</span></span><span class=line><span class=cl>sudo yum-config-manager --add-repo http://mirrors.aliyun.com/docker-ce/linux/centos/docker-ce.repo
</span></span><span class=line><span class=cl><span class=c1># Step 3: 查看可安装的 docker-ce 版本</span>
</span></span><span class=line><span class=cl>yum list docker-ce.x86_64 --showduplicates <span class=p>|</span> sort -r
</span></span><span class=line><span class=cl><span class=c1># Step 4 : 安装指定版本的Docker-CE</span>
</span></span><span class=line><span class=cl>sudo yum -y --setopt<span class=o>=</span><span class=nv>obsoletes</span><span class=o>=</span><span class=m>0</span> install docker-ce-<span class=o>[</span>VERSION<span class=o>]</span> docker-ce-selinux-<span class=o>[</span>VERSION<span class=o>]</span>
</span></span><span class=line><span class=cl><span class=c1># Step 5: 开启Docker服务</span>
</span></span><span class=line><span class=cl>sudo systemctl <span class=nb>enable</span> docker <span class=o>&amp;&amp;</span> systemctl start docker
</span></span></code></pre></div><ul><li>安装成功后验证</li></ul><div class=highlight><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell><span class=line><span class=cl>docker version
</span></span></code></pre></div><div class=highlight><pre tabindex=0 class=chroma><code class=language-text data-lang=text><span class=line><span class=cl>Client: Docker Engine - Community
</span></span><span class=line><span class=cl> Version:           20.10.3
</span></span><span class=line><span class=cl> API version:       1.40
</span></span><span class=line><span class=cl> Go version:        go1.13.15
</span></span><span class=line><span class=cl> Git commit:        48d30b5
</span></span><span class=line><span class=cl> Built:             Fri Jan 29 14:34:14 2021
</span></span><span class=line><span class=cl> OS/Arch:           linux/amd64
</span></span><span class=line><span class=cl> Context:           default
</span></span><span class=line><span class=cl> Experimental:      true
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>Server: Docker Engine - Community
</span></span><span class=line><span class=cl> Engine:
</span></span><span class=line><span class=cl>  Version:          19.03.10
</span></span><span class=line><span class=cl>  API version:      1.40 (minimum version 1.12)
</span></span><span class=line><span class=cl>  Go version:       go1.13.10
</span></span><span class=line><span class=cl>  Git commit:       9424aeaee9
</span></span><span class=line><span class=cl>  Built:            Thu May 28 22:16:43 2020
</span></span><span class=line><span class=cl>  OS/Arch:          linux/amd64
</span></span><span class=line><span class=cl>  Experimental:     false
</span></span><span class=line><span class=cl> containerd:
</span></span><span class=line><span class=cl>  Version:          1.4.3
</span></span><span class=line><span class=cl>  GitCommit:        269548fa27e0089a8b8278fc4fc781d7f65a939b
</span></span><span class=line><span class=cl> runc:
</span></span><span class=line><span class=cl>  Version:          1.0.0-rc92
</span></span><span class=line><span class=cl>  GitCommit:        ff819c7e9184c13b7c2607fe6c30ae19403a7aff
</span></span><span class=line><span class=cl> docker-init:
</span></span><span class=line><span class=cl>  Version:          0.18.0
</span></span><span class=line><span class=cl>  GitCommit:        fec3683
</span></span></code></pre></div><h2 id=安装kubeadmkubeletkubectl>安装kubeadm，kubelet，kubectl<a hidden class=anchor aria-hidden=true href=#安装kubeadmkubeletkubectl>#</a></h2><ul><li>修改 yum 源</li></ul><div class=highlight><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell><span class=line><span class=cl>cat <span class=s>&lt;&lt;EOF &gt; /etc/yum.repos.d/kubernetes.repo
</span></span></span><span class=line><span class=cl><span class=s>[kubernetes]
</span></span></span><span class=line><span class=cl><span class=s>name=Kubernetes
</span></span></span><span class=line><span class=cl><span class=s>baseurl=https://mirrors.aliyun.com/kubernetes/yum/repos/kubernetes-el7-x86_64/
</span></span></span><span class=line><span class=cl><span class=s>enabled=1
</span></span></span><span class=line><span class=cl><span class=s>gpgcheck=1
</span></span></span><span class=line><span class=cl><span class=s>repo_gpgcheck=1
</span></span></span><span class=line><span class=cl><span class=s>gpgkey=https://mirrors.aliyun.com/kubernetes/yum/doc/yum-key.gpg https://mirrors.aliyun.com/kubernetes/yum/doc/rpm-package-key.gpg
</span></span></span><span class=line><span class=cl><span class=s>EOF</span>
</span></span></code></pre></div><ul><li>安装 <code>kubelet</code> <code>kubeadm</code> <code>kubectl</code></li></ul><div class=highlight><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell><span class=line><span class=cl>yum install -y kubelet kubeadm kubectl
</span></span><span class=line><span class=cl>systemctl <span class=nb>enable</span> kubelet <span class=o>&amp;&amp;</span> systemctl start kubelet
</span></span></code></pre></div><ul><li>创建 kubeadm init 初始化文件 (仅master)</li></ul><div class=highlight><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell><span class=line><span class=cl>vim kubeadm-init.yaml
</span></span></code></pre></div><div class=highlight><pre tabindex=0 class=chroma><code class=language-yaml data-lang=yaml><span class=line><span class=cl><span class=nt>apiVersion</span><span class=p>:</span><span class=w> </span><span class=l>kubeadm.k8s.io/v1beta2</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>kind</span><span class=p>:</span><span class=w> </span><span class=l>ClusterConfiguration</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>kubernetesVersion</span><span class=p>:</span><span class=w> </span><span class=l>v1.20.0</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>imageRepository</span><span class=p>:</span><span class=w> </span><span class=l>registry.aliyuncs.com/k8sxio</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>controlPlaneEndpoint</span><span class=p>:</span><span class=w> </span><span class=s2>&#34;192.168.111.128:6443&#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>networking</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>serviceSubnet</span><span class=p>:</span><span class=w> </span><span class=s2>&#34;10.96.0.0/16&#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>podSubnet</span><span class=p>:</span><span class=w> </span><span class=s2>&#34;10.100.0.1/16&#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>dnsDomain</span><span class=p>:</span><span class=w> </span><span class=s2>&#34;192.168.111.128&#34;</span><span class=w>
</span></span></span></code></pre></div><ul><li>初始化 (仅master)</li></ul><div class=highlight><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell><span class=line><span class=cl>kubeadm init --config kubeadm-init.yaml
</span></span></code></pre></div><div class=highlight><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell><span class=line><span class=cl><span class=c1># 初始化完成后，会有以下提示出现</span>
</span></span><span class=line><span class=cl>kubeadm join --token &lt;token&gt; &lt;master-ip&gt;:&lt;master-port&gt; --discovery-token-ca-cert-hash sha256:&lt;hash&gt;
</span></span></code></pre></div><ul><li>配置 kubectl (仅master), node上需要使用时，需要拷贝 config 文件</li></ul><div class=highlight><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell><span class=line><span class=cl>mkdir -p ~/.kube
</span></span><span class=line><span class=cl>sudo cp -i /etc/kubernetes/admin.conf ~/.kube/config
</span></span><span class=line><span class=cl>sudo chown <span class=k>$(</span>id -u<span class=k>)</span>:<span class=k>$(</span>id -g<span class=k>)</span> ~/.kube/config
</span></span></code></pre></div><ul><li>[警告] 当配置错误时可以使用</li></ul><div class=highlight><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell><span class=line><span class=cl>kubeadm reset
</span></span></code></pre></div><ul><li>安装Pod Network</li></ul><div class=highlight><pre tabindex=0 class=chroma><code class=language-text data-lang=text><span class=line><span class=cl># 比较知名的网络解决方案:
</span></span><span class=line><span class=cl>flannel
</span></span><span class=line><span class=cl>calico
</span></span><span class=line><span class=cl>canel
</span></span><span class=line><span class=cl>kube-router
</span></span><span class=line><span class=cl>weave
</span></span><span class=line><span class=cl>.......
</span></span></code></pre></div><ul><li><p>flannel</p><ul><li>[*] flannel 如果需要跨主机修改配置信息<ul><li>host-gw</li></ul><div class=highlight><pre tabindex=0 class=chroma><code class=language-yaml data-lang=yaml><span class=line><span class=cl><span class=nt>net-conf.json</span><span class=p>:</span><span class=w> </span><span class=p>|</span><span class=sd>
</span></span></span><span class=line><span class=cl><span class=sd>  {
</span></span></span><span class=line><span class=cl><span class=sd>    &#34;Network&#34;: &#34;10.244.0.0/16&#34;,
</span></span></span><span class=line><span class=cl><span class=sd>    &#34;Backend&#34;: {
</span></span></span><span class=line><span class=cl><span class=sd>      &#34;Type&#34;: &#34;host-gw&#34;
</span></span></span><span class=line><span class=cl><span class=sd>    }
</span></span></span><span class=line><span class=cl><span class=sd>  }</span><span class=w>  
</span></span></span></code></pre></div><ul><li>vxlan 要打开直接路由转发方式</li></ul><div class=highlight><pre tabindex=0 class=chroma><code class=language-yaml data-lang=yaml><span class=line><span class=cl><span class=nt>net-conf.json</span><span class=p>:</span><span class=w> </span><span class=p>|</span><span class=sd>
</span></span></span><span class=line><span class=cl><span class=sd>  {
</span></span></span><span class=line><span class=cl><span class=sd>    &#34;Network&#34;: &#34;10.244.0.0/16&#34;,
</span></span></span><span class=line><span class=cl><span class=sd>    &#34;Backend&#34;: {
</span></span></span><span class=line><span class=cl><span class=sd>      &#34;Type&#34;: &#34;vxlan&#34;,
</span></span></span><span class=line><span class=cl><span class=sd>      &#34;Directrouting&#34;: true
</span></span></span><span class=line><span class=cl><span class=sd>    }
</span></span></span><span class=line><span class=cl><span class=sd>  }</span><span class=w>  
</span></span></span></code></pre></div></li></ul></li></ul><div class=highlight><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell><span class=line><span class=cl><span class=c1># 下载 至 本地</span>
</span></span><span class=line><span class=cl>wget https://raw.githubusercontent.com/coreos/flannel/master/Documentation/kube-flannel.yml
</span></span><span class=line><span class=cl><span class=c1># 如果打不开也可以自行复制 https://github.com/coreos/flannel/blob/master/Documentation/kube-flannel.yml</span>
</span></span><span class=line><span class=cl>kubectl apply -f kube-flannel.yml
</span></span></code></pre></div><ul><li>weave</li></ul><div class=highlight><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell><span class=line><span class=cl>kubectl apply -f <span class=s2>&#34;https://cloud.weave.works/k8s/net?k8s-version=</span><span class=k>$(</span>kubectl version <span class=p>|</span> base64 <span class=p>|</span> tr -d <span class=s1>&#39;\n&#39;</span><span class=k>)</span><span class=s2>&#34;</span> 
</span></span><span class=line><span class=cl>kubeadm config print init-defaults
</span></span></code></pre></div><ul><li>查看当前 Pod 状态</li></ul><div class=highlight><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell><span class=line><span class=cl>kubectl get pod -A -o wide
</span></span></code></pre></div><ul><li>在 node 上执行 kubeadm init 完成时提示的命令</li></ul><div class=highlight><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell><span class=line><span class=cl>kubeadm join --token &lt;token&gt; &lt;master-ip&gt;:&lt;master-port&gt; --discovery-token-ca-cert-hash sha256:&lt;hash&gt;
</span></span></code></pre></div><ul><li>再次查看当前 Pod 状态</li></ul><div class=highlight><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell><span class=line><span class=cl><span class=c1># -A == -all-namespace</span>
</span></span><span class=line><span class=cl>kubectl get pod -A -o wide
</span></span></code></pre></div><div class=highlight><pre tabindex=0 class=chroma><code class=language-text data-lang=text><span class=line><span class=cl>NAMESPACE     NAME                             READY   STATUS    RESTARTS   AGE   IP                NODE     NOMINATED NODE   READINESS GATES
</span></span><span class=line><span class=cl>kube-system   coredns-68b9d7b887-2pswd         1/1     Running   1          22h   10.100.0.5        master   &lt;none&gt;           &lt;none&gt;
</span></span><span class=line><span class=cl>kube-system   coredns-68b9d7b887-7t42s         1/1     Running   1          22h   10.100.0.4        master   &lt;none&gt;           &lt;none&gt;
</span></span><span class=line><span class=cl>kube-system   etcd-master                      1/1     Running   1          22h   192.168.111.128   master   &lt;none&gt;           &lt;none&gt;
</span></span><span class=line><span class=cl>kube-system   kube-apiserver-master            1/1     Running   1          22h   192.168.111.128   master   &lt;none&gt;           &lt;none&gt;
</span></span><span class=line><span class=cl>kube-system   kube-controller-manager-master   1/1     Running   1          22h   192.168.111.128   master   &lt;none&gt;           &lt;none&gt;
</span></span><span class=line><span class=cl>kube-system   kube-flannel-ds-5h8jr            1/1     Running   1          22h   192.168.111.130   node2    &lt;none&gt;           &lt;none&gt;
</span></span><span class=line><span class=cl>kube-system   kube-flannel-ds-gzzhz            1/1     Running   1          22h   192.168.111.128   master   &lt;none&gt;           &lt;none&gt;
</span></span><span class=line><span class=cl>kube-system   kube-flannel-ds-pxh9j            1/1     Running   7          22h   192.168.111.129   node1    &lt;none&gt;           &lt;none&gt;
</span></span><span class=line><span class=cl>kube-system   kube-proxy-cxphf                 1/1     Running   1          22h   192.168.111.130   node2    &lt;none&gt;           &lt;none&gt;
</span></span><span class=line><span class=cl>kube-system   kube-proxy-hzh4k                 1/1     Running   1          22h   192.168.111.129   node1    &lt;none&gt;           &lt;none&gt;
</span></span><span class=line><span class=cl>kube-system   kube-proxy-kktrf                 1/1     Running   1          22h   192.168.111.128   master   &lt;none&gt;           &lt;none&gt;
</span></span><span class=line><span class=cl>kube-system   kube-scheduler-master            1/1     Running   1          22h   192.168.111.128   master   &lt;none&gt;           &lt;none&gt;
</span></span></code></pre></div></div><footer class=post-footer><ul class=post-tags><li><a href=https://blog.moyrn.com/tags/kubernetes/>Kubernetes</a></li></ul><nav class=paginav><a class=prev href=https://blog.moyrn.com/posts/20210212_pod_project/><span class=title>« 上一页</span><br><span>Pod 对象</span>
</a><a class=next href=https://blog.moyrn.com/posts/20210206_before_start/><span class=title>下一页 »</span><br><span>Kubernetes入门-基础</span></a></nav></footer></article></main><footer class=footer><span>&copy; 2025 <a href=https://blog.moyrn.com/>Moyrne'Blog</a></span> ·
<span>Powered by
<a href=https://gohugo.io/ rel="noopener noreferrer" target=_blank>Hugo</a> &
        <a href=https://github.com/adityatelange/hugo-PaperMod/ rel=noopener target=_blank>PaperMod</a></span></footer><a href=#top aria-label="go to top" title="Go to Top (Alt + G)" class=top-link id=top-link accesskey=g><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 12 6" fill="currentcolor"><path d="M12 6H0l6-6z"/></svg>
</a><script>let menu=document.getElementById("menu");menu&&(menu.scrollLeft=localStorage.getItem("menu-scroll-position"),menu.onscroll=function(){localStorage.setItem("menu-scroll-position",menu.scrollLeft)}),document.querySelectorAll('a[href^="#"]').forEach(e=>{e.addEventListener("click",function(e){e.preventDefault();var t=this.getAttribute("href").substr(1);window.matchMedia("(prefers-reduced-motion: reduce)").matches?document.querySelector(`[id='${decodeURIComponent(t)}']`).scrollIntoView():document.querySelector(`[id='${decodeURIComponent(t)}']`).scrollIntoView({behavior:"smooth"}),t==="top"?history.replaceState(null,null," "):history.pushState(null,null,`#${t}`)})})</script><script>var mybutton=document.getElementById("top-link");window.onscroll=function(){document.body.scrollTop>800||document.documentElement.scrollTop>800?(mybutton.style.visibility="visible",mybutton.style.opacity="1"):(mybutton.style.visibility="hidden",mybutton.style.opacity="0")}</script><script>document.getElementById("theme-toggle").addEventListener("click",()=>{document.body.className.includes("dark")?(document.body.classList.remove("dark"),localStorage.setItem("pref-theme","light")):(document.body.classList.add("dark"),localStorage.setItem("pref-theme","dark"))})</script><script>document.querySelectorAll("pre > code").forEach(e=>{const n=e.parentNode.parentNode,t=document.createElement("button");t.classList.add("copy-code"),t.innerHTML="复制";function s(){t.innerHTML="已复制！",setTimeout(()=>{t.innerHTML="复制"},2e3)}t.addEventListener("click",t=>{if("clipboard"in navigator){navigator.clipboard.writeText(e.textContent),s();return}const n=document.createRange();n.selectNodeContents(e);const o=window.getSelection();o.removeAllRanges(),o.addRange(n);try{document.execCommand("copy"),s()}catch{}o.removeRange(n)}),n.classList.contains("highlight")?n.appendChild(t):n.parentNode.firstChild==n||(e.parentNode.parentNode.parentNode.parentNode.parentNode.nodeName=="TABLE"?e.parentNode.parentNode.parentNode.parentNode.parentNode.appendChild(t):e.parentNode.appendChild(t))})</script></body></html>