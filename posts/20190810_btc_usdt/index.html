<!doctype html><html lang=zh dir=auto><head><meta charset=utf-8><meta http-equiv=X-UA-Compatible content="IE=edge"><meta name=viewport content="width=device-width,initial-scale=1,shrink-to-fit=no"><meta name=robots content="index, follow"><title>手动构建 OMNI-USDT 请求 | Moyrne'Blog</title>
<meta name=keywords content="golang,区块链"><meta name=description content='手动构建 omni usdt 划转 [2021-03-09] 从有道云笔记搬运至 github pages 在实习期间写的，程序中有打印的这类问题，请忽略。（当时debug用的） package btc import ( "bytes" "encoding/hex" "errors" "fmt" "github.com/astaxie/beego" "github.com/btcsuite/btcd/chaincfg" "github.com/btcsuite/btcd/chaincfg/chainhash" "github.com/btcsuite/btcd/txscript" "github.com/btcsuite/btcd/wire" "github.com/btcsuite/btcutil" "github.com/ethereum/go-ethereum/common/math" "log" "math/big" "$project/db" "$project/models" "$project/node/btc" btc2 "$project/wallet/btc" ) var hexLength = 16 func calAmountUSDT(amount *big.Int) (amountHex string) { amountHexBef := fmt.Sprintf("%x", amount) amountHexLen := len(amountHexBef) var amountHexBytes []byte amountHexBytes = make([]byte, hexLength-amountHexLen) for i := range amountHexBytes { amountHexBytes[i] = &#39;0&#39; } for _, v := range amountHexBef { amountHexBytes = append(amountHexBytes, byte(v)) } amountHex = string(amountHexBytes) return } // 发起usdt转账前先确认usdt余额 func SendTransactionUSDT(from, to, amountUSDT, totalFee string) (txHash string, err error) { var ( //Decimal = "00000000" //omni = "6f6d6e69" minBTCTrans = "546" omni = "6f6d6e69" transactionVarsion = "0000" // 2 byte transactionType = "0000" // 2 byte currencyIdentifier = "0000001f" // 4 byte //currencyIdentifier = "0000001f" // 4 byte //amountUSDT // 8 byte ) var address models.'><meta name=author content><link rel=canonical href=https://blog.moyrn.com/posts/20190810_btc_usdt/><meta name=msvalidate.01 content="XYZabc"><link crossorigin=anonymous href=/assets/css/stylesheet.7c6f16614522af04b2defa8f065540976bf528591885d593dd0e84e5fa08c260.css integrity="sha256-fG8WYUUirwSy3vqPBlVAl2v1KFkYhdWT3Q6E5foIwmA=" rel="preload stylesheet" as=style><link rel=icon href=https://blog.moyrn.com/favicon.ico><link rel=icon type=image/png sizes=16x16 href=https://blog.moyrn.com/favicon.ico><link rel=icon type=image/png sizes=32x32 href=https://blog.moyrn.com/favicon.ico><link rel=apple-touch-icon href=https://blog.moyrn.com/favicon.ico><link rel=mask-icon href=https://blog.moyrn.com/favicon.ico><meta name=theme-color content="#2e2e33"><meta name=msapplication-TileColor content="#2e2e33"><link rel=alternate hreflang=zh href=https://blog.moyrn.com/posts/20190810_btc_usdt/><noscript><style>#theme-toggle,.top-link{display:none}</style><style>@media(prefers-color-scheme:dark){:root{--theme:rgb(29, 30, 32);--entry:rgb(46, 46, 51);--primary:rgb(218, 218, 219);--secondary:rgb(155, 156, 157);--tertiary:rgb(65, 66, 68);--content:rgb(196, 196, 197);--code-block-bg:rgb(46, 46, 51);--code-bg:rgb(55, 56, 62);--border:rgb(51, 51, 51)}.list{background:var(--theme)}.list:not(.dark)::-webkit-scrollbar-track{background:0 0}.list:not(.dark)::-webkit-scrollbar-thumb{border-color:var(--theme)}}</style></noscript><meta property="og:url" content="https://blog.moyrn.com/posts/20190810_btc_usdt/"><meta property="og:site_name" content="Moyrne'Blog"><meta property="og:title" content="手动构建 OMNI-USDT 请求"><meta property="og:description" content='手动构建 omni usdt 划转 [2021-03-09] 从有道云笔记搬运至 github pages 在实习期间写的，程序中有打印的这类问题，请忽略。（当时debug用的） package btc import ( "bytes" "encoding/hex" "errors" "fmt" "github.com/astaxie/beego" "github.com/btcsuite/btcd/chaincfg" "github.com/btcsuite/btcd/chaincfg/chainhash" "github.com/btcsuite/btcd/txscript" "github.com/btcsuite/btcd/wire" "github.com/btcsuite/btcutil" "github.com/ethereum/go-ethereum/common/math" "log" "math/big" "$project/db" "$project/models" "$project/node/btc" btc2 "$project/wallet/btc" ) var hexLength = 16 func calAmountUSDT(amount *big.Int) (amountHex string) { amountHexBef := fmt.Sprintf("%x", amount) amountHexLen := len(amountHexBef) var amountHexBytes []byte amountHexBytes = make([]byte, hexLength-amountHexLen) for i := range amountHexBytes { amountHexBytes[i] = &#39;0&#39; } for _, v := range amountHexBef { amountHexBytes = append(amountHexBytes, byte(v)) } amountHex = string(amountHexBytes) return } // 发起usdt转账前先确认usdt余额 func SendTransactionUSDT(from, to, amountUSDT, totalFee string) (txHash string, err error) { var ( //Decimal = "00000000" //omni = "6f6d6e69" minBTCTrans = "546" omni = "6f6d6e69" transactionVarsion = "0000" // 2 byte transactionType = "0000" // 2 byte currencyIdentifier = "0000001f" // 4 byte //currencyIdentifier = "0000001f" // 4 byte //amountUSDT // 8 byte ) var address models.'><meta property="og:locale" content="zh-CN"><meta property="og:type" content="article"><meta property="article:section" content="posts"><meta property="article:published_time" content="2019-08-10T14:01:07+08:00"><meta property="article:modified_time" content="2019-08-10T14:01:07+08:00"><meta property="article:tag" content="Golang"><meta property="article:tag" content="区块链"><meta name=twitter:card content="summary"><meta name=twitter:title content="手动构建 OMNI-USDT 请求"><meta name=twitter:description content='手动构建 omni usdt 划转 [2021-03-09] 从有道云笔记搬运至 github pages 在实习期间写的，程序中有打印的这类问题，请忽略。（当时debug用的） package btc import ( "bytes" "encoding/hex" "errors" "fmt" "github.com/astaxie/beego" "github.com/btcsuite/btcd/chaincfg" "github.com/btcsuite/btcd/chaincfg/chainhash" "github.com/btcsuite/btcd/txscript" "github.com/btcsuite/btcd/wire" "github.com/btcsuite/btcutil" "github.com/ethereum/go-ethereum/common/math" "log" "math/big" "$project/db" "$project/models" "$project/node/btc" btc2 "$project/wallet/btc" ) var hexLength = 16 func calAmountUSDT(amount *big.Int) (amountHex string) { amountHexBef := fmt.Sprintf("%x", amount) amountHexLen := len(amountHexBef) var amountHexBytes []byte amountHexBytes = make([]byte, hexLength-amountHexLen) for i := range amountHexBytes { amountHexBytes[i] = &#39;0&#39; } for _, v := range amountHexBef { amountHexBytes = append(amountHexBytes, byte(v)) } amountHex = string(amountHexBytes) return } // 发起usdt转账前先确认usdt余额 func SendTransactionUSDT(from, to, amountUSDT, totalFee string) (txHash string, err error) { var ( //Decimal = "00000000" //omni = "6f6d6e69" minBTCTrans = "546" omni = "6f6d6e69" transactionVarsion = "0000" // 2 byte transactionType = "0000" // 2 byte currencyIdentifier = "0000001f" // 4 byte //currencyIdentifier = "0000001f" // 4 byte //amountUSDT // 8 byte ) var address models.'><script type=application/ld+json>{"@context":"https://schema.org","@type":"BreadcrumbList","itemListElement":[{"@type":"ListItem","position":1,"name":"Posts","item":"https://blog.moyrn.com/posts/"},{"@type":"ListItem","position":2,"name":"手动构建 OMNI-USDT 请求","item":"https://blog.moyrn.com/posts/20190810_btc_usdt/"}]}</script><script type=application/ld+json>{"@context":"https://schema.org","@type":"BlogPosting","headline":"手动构建 OMNI-USDT 请求","name":"手动构建 OMNI-USDT 请求","description":"手动构建 omni usdt 划转 [2021-03-09] 从有道云笔记搬运至 github pages 在实习期间写的，程序中有打印的这类问题，请忽略。（当时debug用的） package btc import ( \u0026#34;bytes\u0026#34; \u0026#34;encoding/hex\u0026#34; \u0026#34;errors\u0026#34; \u0026#34;fmt\u0026#34; \u0026#34;github.com/astaxie/beego\u0026#34; \u0026#34;github.com/btcsuite/btcd/chaincfg\u0026#34; \u0026#34;github.com/btcsuite/btcd/chaincfg/chainhash\u0026#34; \u0026#34;github.com/btcsuite/btcd/txscript\u0026#34; \u0026#34;github.com/btcsuite/btcd/wire\u0026#34; \u0026#34;github.com/btcsuite/btcutil\u0026#34; \u0026#34;github.com/ethereum/go-ethereum/common/math\u0026#34; \u0026#34;log\u0026#34; \u0026#34;math/big\u0026#34; \u0026#34;$project/db\u0026#34; \u0026#34;$project/models\u0026#34; \u0026#34;$project/node/btc\u0026#34; btc2 \u0026#34;$project/wallet/btc\u0026#34; ) var hexLength = 16 func calAmountUSDT(amount *big.Int) (amountHex string) { amountHexBef := fmt.Sprintf(\u0026#34;%x\u0026#34;, amount) amountHexLen := len(amountHexBef) var amountHexBytes []byte amountHexBytes = make([]byte, hexLength-amountHexLen) for i := range amountHexBytes { amountHexBytes[i] = \u0026#39;0\u0026#39; } for _, v := range amountHexBef { amountHexBytes = append(amountHexBytes, byte(v)) } amountHex = string(amountHexBytes) return } // 发起usdt转账前先确认usdt余额 func SendTransactionUSDT(from, to, amountUSDT, totalFee string) (txHash string, err error) { var ( //Decimal = \u0026#34;00000000\u0026#34; //omni = \u0026#34;6f6d6e69\u0026#34; minBTCTrans = \u0026#34;546\u0026#34; omni = \u0026#34;6f6d6e69\u0026#34; transactionVarsion = \u0026#34;0000\u0026#34; // 2 byte transactionType = \u0026#34;0000\u0026#34; // 2 byte currencyIdentifier = \u0026#34;0000001f\u0026#34; // 4 byte //currencyIdentifier = \u0026#34;0000001f\u0026#34; // 4 byte //amountUSDT // 8 byte ) var address models.","keywords":["golang","区块链"],"articleBody":"手动构建 omni usdt 划转 [2021-03-09] 从有道云笔记搬运至 github pages 在实习期间写的，程序中有打印的这类问题，请忽略。（当时debug用的） package btc import ( \"bytes\" \"encoding/hex\" \"errors\" \"fmt\" \"github.com/astaxie/beego\" \"github.com/btcsuite/btcd/chaincfg\" \"github.com/btcsuite/btcd/chaincfg/chainhash\" \"github.com/btcsuite/btcd/txscript\" \"github.com/btcsuite/btcd/wire\" \"github.com/btcsuite/btcutil\" \"github.com/ethereum/go-ethereum/common/math\" \"log\" \"math/big\" \"$project/db\" \"$project/models\" \"$project/node/btc\" btc2 \"$project/wallet/btc\" ) var hexLength = 16 func calAmountUSDT(amount *big.Int) (amountHex string) { amountHexBef := fmt.Sprintf(\"%x\", amount) amountHexLen := len(amountHexBef) var amountHexBytes []byte amountHexBytes = make([]byte, hexLength-amountHexLen) for i := range amountHexBytes { amountHexBytes[i] = '0' } for _, v := range amountHexBef { amountHexBytes = append(amountHexBytes, byte(v)) } amountHex = string(amountHexBytes) return } // 发起usdt转账前先确认usdt余额 func SendTransactionUSDT(from, to, amountUSDT, totalFee string) (txHash string, err error) { var ( //Decimal = \"00000000\" //omni = \"6f6d6e69\" minBTCTrans = \"546\" omni = \"6f6d6e69\" transactionVarsion = \"0000\" // 2 byte transactionType = \"0000\" // 2 byte currencyIdentifier = \"0000001f\" // 4 byte //currencyIdentifier = \"0000001f\" // 4 byte //amountUSDT // 8 byte ) var address models.Address if err := db.DB.Where(\"address=? and chain_coin=?\", from, \"btc\"). First(\u0026address).Error; err != nil { return \"\", err } amountUSDTToSend, _ := math.ParseBig256(amountUSDT) amountUSDTHex := calAmountUSDT(amountUSDTToSend) chainParams := \u0026chaincfg.MainNetParams log.Printf(\"total fee: %s\", totalFee) totalFeeBig, _ := math.ParseBig256(totalFee) amountToSend, _ := math.ParseBig256(minBTCTrans) feeRate, err := btc2.GetCurrentFeeRate() log.Printf(\"current fee rate: %v\", feeRate) if err != nil { beego.Error(\"GetCurrentFeeRate\", err) return \"\", err } fromWalletPublicAddress := from log.Printf(\"from wallet public address: %s\", fromWalletPublicAddress) unspentTXOs, err := btc2.ListUnspentTXOs(fromWalletPublicAddress) if err != nil { beego.Error(\"ListUnspentTXOs\", err) return \"\", err } if unspentTXOs == nil { beego.Error(\"marshalUTXOs unspentTXOs is nil\") return \"\", errors.New(\"marshalUTXOs unspentTXOs is nil\") } //UTXOsAmount := big.NewInt(0) //for _, unspentTXO := range unspentTXOs { //\tUTXOsAmount = new(big.Int).Add(UTXOsAmount, unspentTXO.Amount) //} // TODO:marshalUTXOs 存在问题，筛选后UTXOsAmount与unspentTXO不对应， // unspentTXO中金额过低，疑似选错了UTXO unspentTXOs, UTXOsAmount, err := btc2.MarshalUTXOs(unspentTXOs, amountToSend, feeRate,3) if err != nil { beego.Error(\"marshalUTXOs\", err) return \"\", err } // prepare unspent transaction outputs with its privatekey. log.Println(\"unspent UTXOs\", unspentTXOs, UTXOsAmount) tx := wire.NewMsgTx(wire.TxVersion) var sourceUTXOs []*btc2.UTXO // prepare tx ins for idx := range unspentTXOs { hashStr := unspentTXOs[idx].Hash sourceUTXOHash, err := chainhash.NewHashFromStr(hashStr) if err != nil { beego.Error(err) return \"\", err } sourceUTXOIndex := uint32(unspentTXOs[idx].TxIndex) sourceUTXO := wire.NewOutPoint(sourceUTXOHash, sourceUTXOIndex) sourceUTXOs = append(sourceUTXOs, unspentTXOs[idx]) sourceTxIn := wire.NewTxIn(sourceUTXO, nil, nil) fmt.Println(sourceTxIn) tx.AddTxIn(sourceTxIn) } // calculate the change change := new(big.Int).Set(UTXOsAmount) change = new(big.Int).Sub(change, amountToSend) change = new(big.Int).Sub(change, totalFeeBig) if change.Cmp(big.NewInt(0)) == -1 { return \"\", err } destinationAddress := to // create the tx outs destAddress, err := btcutil.DecodeAddress(destinationAddress, chainParams) if err != nil { beego.Error(err) return \"\", err } fmt.Println(destAddress.EncodeAddress(), destAddress.String()) destScript, err := txscript.PayToAddrScript(destAddress) if err != nil { beego.Error(err) return \"\", err } // tx out to send btc to user destOutput := wire.NewTxOut(amountToSend.Int64(), destScript) tx.AddTxOut(destOutput) //txscript.OP_RETURN // usdt转账 OP_RETURN 备注 //usdtOut, err := txscript.NullDataScript([]byte(\"OP_RETURN \" + omni + transactionVarsion + transactionType + currencyIdentifier + amountUSDTHex)) op_return ,err := hex.DecodeString(omni + transactionVarsion + transactionType + currencyIdentifier + amountUSDTHex) if err != nil { beego.Debug(\"SendTransactionUSDT DecodeString error\",err) return } usdtOut, err := txscript.NullDataScript(op_return) if err != nil { beego.Error(\"SendTransactionUSDT txscript.NullDataScript error\", err) return } //fmt.Println(\"usdtout:\", hex.EncodeToString(usdtOut)) usdtOutput := wire.NewTxOut(int64(0), usdtOut) tx.AddTxOut(usdtOutput) // our change address changeSendToAddress, err := btcutil.DecodeAddress(fromWalletPublicAddress, chainParams) if err != nil { beego.Error(err) return \"\", err } changeSendToScript, err := txscript.PayToAddrScript(changeSendToAddress) if err != nil { beego.Error(err) return \"\", err } // tx out to send change back to us changeOutput := wire.NewTxOut(change.Int64(), changeSendToScript) tx.AddTxOut(changeOutput) privWif := address.PrivateKey decodedWif, err := btcutil.DecodeWIF(privWif) if err != nil { beego.Error(err) return \"\", err } addressPubKey, err := btcutil.NewAddressPubKey(decodedWif.PrivKey.PubKey().SerializeCompressed(), chainParams) if err != nil { beego.Error(err) return \"\", err } sourceAddress, err := btcutil.DecodeAddress(addressPubKey.EncodeAddress(), chainParams) if err != nil { beego.Error(err) return \"\", err } fmt.Printf(\"Source Address: %s\\n\", sourceAddress) sourcePkScript, err := txscript.PayToAddrScript(sourceAddress) if err != nil { beego.Error(err) return \"\", err } for i := range sourceUTXOs { fmt.Println(\"sourceUTXOs[i]:\", sourceUTXOs[i]) sigScript, err := txscript.SignatureScript(tx, i, sourcePkScript, txscript.SigHashAll, decodedWif.PrivKey, true) if err != nil { beego.Error(err) return \"\", err } tx.TxIn[i].SignatureScript = sigScript } for _, tx := range tx.TxIn { fmt.Println(\"TxIn[i]:\", tx) } buf := bytes.NewBuffer(make([]byte, 0, tx.SerializeSize())) _ = tx.Serialize(buf) fmt.Printf(\"Redeem Tx: %v\\n\", hex.EncodeToString(buf.Bytes())) txHash, err = btc.CastTransaction(tx) if err != nil { beego.Error(err) return \"\", err } fmt.Printf(\"tx hash: %s\\n\", txHash) return txHash, nil } ","wordCount":"671","inLanguage":"zh","datePublished":"2019-08-10T14:01:07+08:00","dateModified":"2019-08-10T14:01:07+08:00","mainEntityOfPage":{"@type":"WebPage","@id":"https://blog.moyrn.com/posts/20190810_btc_usdt/"},"publisher":{"@type":"Organization","name":"Moyrne'Blog","logo":{"@type":"ImageObject","url":"https://blog.moyrn.com/favicon.ico"}}}</script></head><body id=top><script>localStorage.getItem("pref-theme")==="dark"?document.body.classList.add("dark"):localStorage.getItem("pref-theme")==="light"?document.body.classList.remove("dark"):window.matchMedia("(prefers-color-scheme: dark)").matches&&document.body.classList.add("dark")</script><header class=header><nav class=nav><div class=logo><a href=https://blog.moyrn.com/ accesskey=h title="Home (Alt + H)">Home</a><div class=logo-switches><button id=theme-toggle accesskey=t title="(Alt + T)" aria-label="Toggle theme"><svg id="moon" xmlns="http://www.w3.org/2000/svg" width="24" height="18" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 12.79A9 9 0 1111.21 3 7 7 0 0021 12.79z"/></svg><svg id="sun" xmlns="http://www.w3.org/2000/svg" width="24" height="18" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="5"/><line x1="12" y1="1" x2="12" y2="3"/><line x1="12" y1="21" x2="12" y2="23"/><line x1="4.22" y1="4.22" x2="5.64" y2="5.64"/><line x1="18.36" y1="18.36" x2="19.78" y2="19.78"/><line x1="1" y1="12" x2="3" y2="12"/><line x1="21" y1="12" x2="23" y2="12"/><line x1="4.22" y1="19.78" x2="5.64" y2="18.36"/><line x1="18.36" y1="5.64" x2="19.78" y2="4.22"/></svg></button></div></div><ul id=menu><li><a href=https://blog.moyrn.com/tags/ title=Tags><span>Tags</span></a></li><li><a href=https://blog.moyrn.com/categories/ title=Categories><span>Categories</span></a></li></ul></nav></header><main class=main><article class=post-single><header class=post-header><div class=breadcrumbs><a href=https://blog.moyrn.com/>主页</a>&nbsp;»&nbsp;<a href=https://blog.moyrn.com/posts/>Posts</a></div><h1 class="post-title entry-hint-parent">手动构建 OMNI-USDT 请求</h1><div class=post-meta><span title='2019-08-10 14:01:07 +0800 +0800'>2019-08-10</span>&nbsp;·&nbsp;4 分钟&nbsp;·&nbsp;671 字</div></header><div class=post-content><h2 id=手动构建-omni-usdt-划转>手动构建 omni usdt 划转<a hidden class=anchor aria-hidden=true href=#手动构建-omni-usdt-划转>#</a></h2><ul><li>[2021-03-09] 从有道云笔记搬运至 <code>github pages</code></li><li>在实习期间写的，程序中有打印的这类问题，请忽略。（当时debug用的）</li></ul><div class=highlight><pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=line><span class=cl><span class=kn>package</span> <span class=nx>btc</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kn>import</span> <span class=p>(</span>
</span></span><span class=line><span class=cl>	<span class=s>&#34;bytes&#34;</span>
</span></span><span class=line><span class=cl>	<span class=s>&#34;encoding/hex&#34;</span>
</span></span><span class=line><span class=cl>	<span class=s>&#34;errors&#34;</span>
</span></span><span class=line><span class=cl>	<span class=s>&#34;fmt&#34;</span>
</span></span><span class=line><span class=cl>	<span class=s>&#34;github.com/astaxie/beego&#34;</span>
</span></span><span class=line><span class=cl>	<span class=s>&#34;github.com/btcsuite/btcd/chaincfg&#34;</span>
</span></span><span class=line><span class=cl>	<span class=s>&#34;github.com/btcsuite/btcd/chaincfg/chainhash&#34;</span>
</span></span><span class=line><span class=cl>	<span class=s>&#34;github.com/btcsuite/btcd/txscript&#34;</span>
</span></span><span class=line><span class=cl>	<span class=s>&#34;github.com/btcsuite/btcd/wire&#34;</span>
</span></span><span class=line><span class=cl>	<span class=s>&#34;github.com/btcsuite/btcutil&#34;</span>
</span></span><span class=line><span class=cl>	<span class=s>&#34;github.com/ethereum/go-ethereum/common/math&#34;</span>
</span></span><span class=line><span class=cl>	<span class=s>&#34;log&#34;</span>
</span></span><span class=line><span class=cl>	<span class=s>&#34;math/big&#34;</span>
</span></span><span class=line><span class=cl>	<span class=s>&#34;$project/db&#34;</span>
</span></span><span class=line><span class=cl>	<span class=s>&#34;$project/models&#34;</span>
</span></span><span class=line><span class=cl>	<span class=s>&#34;$project/node/btc&#34;</span>
</span></span><span class=line><span class=cl>	<span class=nx>btc2</span> <span class=s>&#34;$project/wallet/btc&#34;</span>
</span></span><span class=line><span class=cl><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kd>var</span> <span class=nx>hexLength</span> <span class=p>=</span> <span class=mi>16</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kd>func</span> <span class=nf>calAmountUSDT</span><span class=p>(</span><span class=nx>amount</span> <span class=o>*</span><span class=nx>big</span><span class=p>.</span><span class=nx>Int</span><span class=p>)</span> <span class=p>(</span><span class=nx>amountHex</span> <span class=kt>string</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>	<span class=nx>amountHexBef</span> <span class=o>:=</span> <span class=nx>fmt</span><span class=p>.</span><span class=nf>Sprintf</span><span class=p>(</span><span class=s>&#34;%x&#34;</span><span class=p>,</span> <span class=nx>amount</span><span class=p>)</span>
</span></span><span class=line><span class=cl>	<span class=nx>amountHexLen</span> <span class=o>:=</span> <span class=nb>len</span><span class=p>(</span><span class=nx>amountHexBef</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>	<span class=kd>var</span> <span class=nx>amountHexBytes</span> <span class=p>[]</span><span class=kt>byte</span>
</span></span><span class=line><span class=cl>	<span class=nx>amountHexBytes</span> <span class=p>=</span> <span class=nb>make</span><span class=p>([]</span><span class=kt>byte</span><span class=p>,</span> <span class=nx>hexLength</span><span class=o>-</span><span class=nx>amountHexLen</span><span class=p>)</span>
</span></span><span class=line><span class=cl>	<span class=k>for</span> <span class=nx>i</span> <span class=o>:=</span> <span class=k>range</span> <span class=nx>amountHexBytes</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>		<span class=nx>amountHexBytes</span><span class=p>[</span><span class=nx>i</span><span class=p>]</span> <span class=p>=</span> <span class=sc>&#39;0&#39;</span>
</span></span><span class=line><span class=cl>	<span class=p>}</span>
</span></span><span class=line><span class=cl>	<span class=k>for</span> <span class=nx>_</span><span class=p>,</span> <span class=nx>v</span> <span class=o>:=</span> <span class=k>range</span> <span class=nx>amountHexBef</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>		<span class=nx>amountHexBytes</span> <span class=p>=</span> <span class=nb>append</span><span class=p>(</span><span class=nx>amountHexBytes</span><span class=p>,</span> <span class=nb>byte</span><span class=p>(</span><span class=nx>v</span><span class=p>))</span>
</span></span><span class=line><span class=cl>	<span class=p>}</span>
</span></span><span class=line><span class=cl>	<span class=nx>amountHex</span> <span class=p>=</span> <span class=nb>string</span><span class=p>(</span><span class=nx>amountHexBytes</span><span class=p>)</span>
</span></span><span class=line><span class=cl>	<span class=k>return</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>// 发起usdt转账前先确认usdt余额
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=kd>func</span> <span class=nf>SendTransactionUSDT</span><span class=p>(</span><span class=nx>from</span><span class=p>,</span> <span class=nx>to</span><span class=p>,</span> <span class=nx>amountUSDT</span><span class=p>,</span> <span class=nx>totalFee</span> <span class=kt>string</span><span class=p>)</span> <span class=p>(</span><span class=nx>txHash</span> <span class=kt>string</span><span class=p>,</span> <span class=nx>err</span> <span class=kt>error</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>	<span class=kd>var</span> <span class=p>(</span>
</span></span><span class=line><span class=cl>		<span class=c1>//Decimal            = &#34;00000000&#34;
</span></span></span><span class=line><span class=cl><span class=c1></span>		<span class=c1>//omni               = &#34;6f6d6e69&#34;
</span></span></span><span class=line><span class=cl><span class=c1></span>		<span class=nx>minBTCTrans</span>        <span class=p>=</span> <span class=s>&#34;546&#34;</span>
</span></span><span class=line><span class=cl>		<span class=nx>omni</span>               <span class=p>=</span> <span class=s>&#34;6f6d6e69&#34;</span>
</span></span><span class=line><span class=cl>		<span class=nx>transactionVarsion</span> <span class=p>=</span> <span class=s>&#34;0000&#34;</span>     <span class=c1>// 2 byte
</span></span></span><span class=line><span class=cl><span class=c1></span>		<span class=nx>transactionType</span>    <span class=p>=</span> <span class=s>&#34;0000&#34;</span>     <span class=c1>// 2 byte
</span></span></span><span class=line><span class=cl><span class=c1></span>		<span class=nx>currencyIdentifier</span> <span class=p>=</span> <span class=s>&#34;0000001f&#34;</span> <span class=c1>// 4 byte
</span></span></span><span class=line><span class=cl><span class=c1></span>		<span class=c1>//currencyIdentifier = &#34;0000001f&#34; // 4 byte
</span></span></span><span class=line><span class=cl><span class=c1></span>		<span class=c1>//amountUSDT                	 // 8 byte
</span></span></span><span class=line><span class=cl><span class=c1></span>	<span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>	<span class=kd>var</span> <span class=nx>address</span> <span class=nx>models</span><span class=p>.</span><span class=nx>Address</span>
</span></span><span class=line><span class=cl>	<span class=k>if</span> <span class=nx>err</span> <span class=o>:=</span> <span class=nx>db</span><span class=p>.</span><span class=nx>DB</span><span class=p>.</span><span class=nf>Where</span><span class=p>(</span><span class=s>&#34;address=? and chain_coin=?&#34;</span><span class=p>,</span> <span class=nx>from</span><span class=p>,</span> <span class=s>&#34;btc&#34;</span><span class=p>).</span>
</span></span><span class=line><span class=cl>		<span class=nf>First</span><span class=p>(</span><span class=o>&amp;</span><span class=nx>address</span><span class=p>).</span><span class=nx>Error</span><span class=p>;</span> <span class=nx>err</span> <span class=o>!=</span> <span class=kc>nil</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>		<span class=k>return</span> <span class=s>&#34;&#34;</span><span class=p>,</span> <span class=nx>err</span>
</span></span><span class=line><span class=cl>	<span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>	<span class=nx>amountUSDTToSend</span><span class=p>,</span> <span class=nx>_</span> <span class=o>:=</span> <span class=nx>math</span><span class=p>.</span><span class=nf>ParseBig256</span><span class=p>(</span><span class=nx>amountUSDT</span><span class=p>)</span>
</span></span><span class=line><span class=cl>	<span class=nx>amountUSDTHex</span> <span class=o>:=</span> <span class=nf>calAmountUSDT</span><span class=p>(</span><span class=nx>amountUSDTToSend</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>	<span class=nx>chainParams</span> <span class=o>:=</span> <span class=o>&amp;</span><span class=nx>chaincfg</span><span class=p>.</span><span class=nx>MainNetParams</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>	<span class=nx>log</span><span class=p>.</span><span class=nf>Printf</span><span class=p>(</span><span class=s>&#34;total fee: %s&#34;</span><span class=p>,</span> <span class=nx>totalFee</span><span class=p>)</span>
</span></span><span class=line><span class=cl>	<span class=nx>totalFeeBig</span><span class=p>,</span> <span class=nx>_</span> <span class=o>:=</span> <span class=nx>math</span><span class=p>.</span><span class=nf>ParseBig256</span><span class=p>(</span><span class=nx>totalFee</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>	<span class=nx>amountToSend</span><span class=p>,</span> <span class=nx>_</span> <span class=o>:=</span> <span class=nx>math</span><span class=p>.</span><span class=nf>ParseBig256</span><span class=p>(</span><span class=nx>minBTCTrans</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>	<span class=nx>feeRate</span><span class=p>,</span> <span class=nx>err</span> <span class=o>:=</span> <span class=nx>btc2</span><span class=p>.</span><span class=nf>GetCurrentFeeRate</span><span class=p>()</span>
</span></span><span class=line><span class=cl>	<span class=nx>log</span><span class=p>.</span><span class=nf>Printf</span><span class=p>(</span><span class=s>&#34;current fee rate: %v&#34;</span><span class=p>,</span> <span class=nx>feeRate</span><span class=p>)</span>
</span></span><span class=line><span class=cl>	<span class=k>if</span> <span class=nx>err</span> <span class=o>!=</span> <span class=kc>nil</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>		<span class=nx>beego</span><span class=p>.</span><span class=nf>Error</span><span class=p>(</span><span class=s>&#34;GetCurrentFeeRate&#34;</span><span class=p>,</span> <span class=nx>err</span><span class=p>)</span>
</span></span><span class=line><span class=cl>		<span class=k>return</span> <span class=s>&#34;&#34;</span><span class=p>,</span> <span class=nx>err</span>
</span></span><span class=line><span class=cl>	<span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>	<span class=nx>fromWalletPublicAddress</span> <span class=o>:=</span> <span class=nx>from</span>
</span></span><span class=line><span class=cl>	<span class=nx>log</span><span class=p>.</span><span class=nf>Printf</span><span class=p>(</span><span class=s>&#34;from wallet public address: %s&#34;</span><span class=p>,</span> <span class=nx>fromWalletPublicAddress</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>	<span class=nx>unspentTXOs</span><span class=p>,</span> <span class=nx>err</span> <span class=o>:=</span> <span class=nx>btc2</span><span class=p>.</span><span class=nf>ListUnspentTXOs</span><span class=p>(</span><span class=nx>fromWalletPublicAddress</span><span class=p>)</span>
</span></span><span class=line><span class=cl>	<span class=k>if</span> <span class=nx>err</span> <span class=o>!=</span> <span class=kc>nil</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>		<span class=nx>beego</span><span class=p>.</span><span class=nf>Error</span><span class=p>(</span><span class=s>&#34;ListUnspentTXOs&#34;</span><span class=p>,</span> <span class=nx>err</span><span class=p>)</span>
</span></span><span class=line><span class=cl>		<span class=k>return</span> <span class=s>&#34;&#34;</span><span class=p>,</span> <span class=nx>err</span>
</span></span><span class=line><span class=cl>	<span class=p>}</span>
</span></span><span class=line><span class=cl>	<span class=k>if</span> <span class=nx>unspentTXOs</span> <span class=o>==</span> <span class=kc>nil</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>		<span class=nx>beego</span><span class=p>.</span><span class=nf>Error</span><span class=p>(</span><span class=s>&#34;marshalUTXOs unspentTXOs is nil&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>		<span class=k>return</span> <span class=s>&#34;&#34;</span><span class=p>,</span> <span class=nx>errors</span><span class=p>.</span><span class=nf>New</span><span class=p>(</span><span class=s>&#34;marshalUTXOs unspentTXOs is nil&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>	<span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>	<span class=c1>//UTXOsAmount := big.NewInt(0)
</span></span></span><span class=line><span class=cl><span class=c1></span>	<span class=c1>//for _, unspentTXO := range unspentTXOs {
</span></span></span><span class=line><span class=cl><span class=c1></span>	<span class=c1>//	UTXOsAmount = new(big.Int).Add(UTXOsAmount, unspentTXO.Amount)
</span></span></span><span class=line><span class=cl><span class=c1></span>	<span class=c1>//}
</span></span></span><span class=line><span class=cl><span class=c1></span>	<span class=c1>// TODO:marshalUTXOs 存在问题，筛选后UTXOsAmount与unspentTXO不对应，
</span></span></span><span class=line><span class=cl><span class=c1></span>	<span class=c1>//  unspentTXO中金额过低，疑似选错了UTXO
</span></span></span><span class=line><span class=cl><span class=c1></span>	<span class=nx>unspentTXOs</span><span class=p>,</span> <span class=nx>UTXOsAmount</span><span class=p>,</span> <span class=nx>err</span> <span class=o>:=</span> <span class=nx>btc2</span><span class=p>.</span><span class=nf>MarshalUTXOs</span><span class=p>(</span><span class=nx>unspentTXOs</span><span class=p>,</span> <span class=nx>amountToSend</span><span class=p>,</span> <span class=nx>feeRate</span><span class=p>,</span><span class=mi>3</span><span class=p>)</span>
</span></span><span class=line><span class=cl>	<span class=k>if</span> <span class=nx>err</span> <span class=o>!=</span> <span class=kc>nil</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>		<span class=nx>beego</span><span class=p>.</span><span class=nf>Error</span><span class=p>(</span><span class=s>&#34;marshalUTXOs&#34;</span><span class=p>,</span> <span class=nx>err</span><span class=p>)</span>
</span></span><span class=line><span class=cl>		<span class=k>return</span> <span class=s>&#34;&#34;</span><span class=p>,</span> <span class=nx>err</span>
</span></span><span class=line><span class=cl>	<span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>	<span class=c1>// prepare unspent transaction outputs with its privatekey.
</span></span></span><span class=line><span class=cl><span class=c1></span>	<span class=nx>log</span><span class=p>.</span><span class=nf>Println</span><span class=p>(</span><span class=s>&#34;unspent UTXOs&#34;</span><span class=p>,</span> <span class=nx>unspentTXOs</span><span class=p>,</span> <span class=nx>UTXOsAmount</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>	<span class=nx>tx</span> <span class=o>:=</span> <span class=nx>wire</span><span class=p>.</span><span class=nf>NewMsgTx</span><span class=p>(</span><span class=nx>wire</span><span class=p>.</span><span class=nx>TxVersion</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>	<span class=kd>var</span> <span class=nx>sourceUTXOs</span> <span class=p>[]</span><span class=o>*</span><span class=nx>btc2</span><span class=p>.</span><span class=nx>UTXO</span>
</span></span><span class=line><span class=cl>	<span class=c1>// prepare tx ins
</span></span></span><span class=line><span class=cl><span class=c1></span>	<span class=k>for</span> <span class=nx>idx</span> <span class=o>:=</span> <span class=k>range</span> <span class=nx>unspentTXOs</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>		<span class=nx>hashStr</span> <span class=o>:=</span> <span class=nx>unspentTXOs</span><span class=p>[</span><span class=nx>idx</span><span class=p>].</span><span class=nx>Hash</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>		<span class=nx>sourceUTXOHash</span><span class=p>,</span> <span class=nx>err</span> <span class=o>:=</span> <span class=nx>chainhash</span><span class=p>.</span><span class=nf>NewHashFromStr</span><span class=p>(</span><span class=nx>hashStr</span><span class=p>)</span>
</span></span><span class=line><span class=cl>		<span class=k>if</span> <span class=nx>err</span> <span class=o>!=</span> <span class=kc>nil</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>			<span class=nx>beego</span><span class=p>.</span><span class=nf>Error</span><span class=p>(</span><span class=nx>err</span><span class=p>)</span>
</span></span><span class=line><span class=cl>			<span class=k>return</span> <span class=s>&#34;&#34;</span><span class=p>,</span> <span class=nx>err</span>
</span></span><span class=line><span class=cl>		<span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>		<span class=nx>sourceUTXOIndex</span> <span class=o>:=</span> <span class=nb>uint32</span><span class=p>(</span><span class=nx>unspentTXOs</span><span class=p>[</span><span class=nx>idx</span><span class=p>].</span><span class=nx>TxIndex</span><span class=p>)</span>
</span></span><span class=line><span class=cl>		<span class=nx>sourceUTXO</span> <span class=o>:=</span> <span class=nx>wire</span><span class=p>.</span><span class=nf>NewOutPoint</span><span class=p>(</span><span class=nx>sourceUTXOHash</span><span class=p>,</span> <span class=nx>sourceUTXOIndex</span><span class=p>)</span>
</span></span><span class=line><span class=cl>		<span class=nx>sourceUTXOs</span> <span class=p>=</span> <span class=nb>append</span><span class=p>(</span><span class=nx>sourceUTXOs</span><span class=p>,</span> <span class=nx>unspentTXOs</span><span class=p>[</span><span class=nx>idx</span><span class=p>])</span>
</span></span><span class=line><span class=cl>		<span class=nx>sourceTxIn</span> <span class=o>:=</span> <span class=nx>wire</span><span class=p>.</span><span class=nf>NewTxIn</span><span class=p>(</span><span class=nx>sourceUTXO</span><span class=p>,</span> <span class=kc>nil</span><span class=p>,</span> <span class=kc>nil</span><span class=p>)</span>
</span></span><span class=line><span class=cl>		<span class=nx>fmt</span><span class=p>.</span><span class=nf>Println</span><span class=p>(</span><span class=nx>sourceTxIn</span><span class=p>)</span>
</span></span><span class=line><span class=cl>		<span class=nx>tx</span><span class=p>.</span><span class=nf>AddTxIn</span><span class=p>(</span><span class=nx>sourceTxIn</span><span class=p>)</span>
</span></span><span class=line><span class=cl>	<span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>	<span class=c1>// calculate the change
</span></span></span><span class=line><span class=cl><span class=c1></span>	<span class=nx>change</span> <span class=o>:=</span> <span class=nb>new</span><span class=p>(</span><span class=nx>big</span><span class=p>.</span><span class=nx>Int</span><span class=p>).</span><span class=nf>Set</span><span class=p>(</span><span class=nx>UTXOsAmount</span><span class=p>)</span>
</span></span><span class=line><span class=cl>	<span class=nx>change</span> <span class=p>=</span> <span class=nb>new</span><span class=p>(</span><span class=nx>big</span><span class=p>.</span><span class=nx>Int</span><span class=p>).</span><span class=nf>Sub</span><span class=p>(</span><span class=nx>change</span><span class=p>,</span> <span class=nx>amountToSend</span><span class=p>)</span>
</span></span><span class=line><span class=cl>	<span class=nx>change</span> <span class=p>=</span> <span class=nb>new</span><span class=p>(</span><span class=nx>big</span><span class=p>.</span><span class=nx>Int</span><span class=p>).</span><span class=nf>Sub</span><span class=p>(</span><span class=nx>change</span><span class=p>,</span> <span class=nx>totalFeeBig</span><span class=p>)</span>
</span></span><span class=line><span class=cl>	<span class=k>if</span> <span class=nx>change</span><span class=p>.</span><span class=nf>Cmp</span><span class=p>(</span><span class=nx>big</span><span class=p>.</span><span class=nf>NewInt</span><span class=p>(</span><span class=mi>0</span><span class=p>))</span> <span class=o>==</span> <span class=o>-</span><span class=mi>1</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>		<span class=k>return</span> <span class=s>&#34;&#34;</span><span class=p>,</span> <span class=nx>err</span>
</span></span><span class=line><span class=cl>	<span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>	<span class=nx>destinationAddress</span> <span class=o>:=</span> <span class=nx>to</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>	<span class=c1>// create the tx outs
</span></span></span><span class=line><span class=cl><span class=c1></span>	<span class=nx>destAddress</span><span class=p>,</span> <span class=nx>err</span> <span class=o>:=</span> <span class=nx>btcutil</span><span class=p>.</span><span class=nf>DecodeAddress</span><span class=p>(</span><span class=nx>destinationAddress</span><span class=p>,</span> <span class=nx>chainParams</span><span class=p>)</span>
</span></span><span class=line><span class=cl>	<span class=k>if</span> <span class=nx>err</span> <span class=o>!=</span> <span class=kc>nil</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>		<span class=nx>beego</span><span class=p>.</span><span class=nf>Error</span><span class=p>(</span><span class=nx>err</span><span class=p>)</span>
</span></span><span class=line><span class=cl>		<span class=k>return</span> <span class=s>&#34;&#34;</span><span class=p>,</span> <span class=nx>err</span>
</span></span><span class=line><span class=cl>	<span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>	<span class=nx>fmt</span><span class=p>.</span><span class=nf>Println</span><span class=p>(</span><span class=nx>destAddress</span><span class=p>.</span><span class=nf>EncodeAddress</span><span class=p>(),</span> <span class=nx>destAddress</span><span class=p>.</span><span class=nf>String</span><span class=p>())</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>	<span class=nx>destScript</span><span class=p>,</span> <span class=nx>err</span> <span class=o>:=</span> <span class=nx>txscript</span><span class=p>.</span><span class=nf>PayToAddrScript</span><span class=p>(</span><span class=nx>destAddress</span><span class=p>)</span>
</span></span><span class=line><span class=cl>	<span class=k>if</span> <span class=nx>err</span> <span class=o>!=</span> <span class=kc>nil</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>		<span class=nx>beego</span><span class=p>.</span><span class=nf>Error</span><span class=p>(</span><span class=nx>err</span><span class=p>)</span>
</span></span><span class=line><span class=cl>		<span class=k>return</span> <span class=s>&#34;&#34;</span><span class=p>,</span> <span class=nx>err</span>
</span></span><span class=line><span class=cl>	<span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>	<span class=c1>// tx out to send btc to user
</span></span></span><span class=line><span class=cl><span class=c1></span>	<span class=nx>destOutput</span> <span class=o>:=</span> <span class=nx>wire</span><span class=p>.</span><span class=nf>NewTxOut</span><span class=p>(</span><span class=nx>amountToSend</span><span class=p>.</span><span class=nf>Int64</span><span class=p>(),</span> <span class=nx>destScript</span><span class=p>)</span>
</span></span><span class=line><span class=cl>	<span class=nx>tx</span><span class=p>.</span><span class=nf>AddTxOut</span><span class=p>(</span><span class=nx>destOutput</span><span class=p>)</span>
</span></span><span class=line><span class=cl>	<span class=c1>//txscript.OP_RETURN
</span></span></span><span class=line><span class=cl><span class=c1></span>	<span class=c1>// usdt转账   OP_RETURN 备注
</span></span></span><span class=line><span class=cl><span class=c1></span>	<span class=c1>//usdtOut, err := txscript.NullDataScript([]byte(&#34;OP_RETURN &#34; + omni + transactionVarsion + transactionType + currencyIdentifier + amountUSDTHex))
</span></span></span><span class=line><span class=cl><span class=c1></span>
</span></span><span class=line><span class=cl>	<span class=nx>op_return</span> <span class=p>,</span><span class=nx>err</span> <span class=o>:=</span> <span class=nx>hex</span><span class=p>.</span><span class=nf>DecodeString</span><span class=p>(</span><span class=nx>omni</span> <span class=o>+</span> <span class=nx>transactionVarsion</span> <span class=o>+</span> <span class=nx>transactionType</span> <span class=o>+</span> <span class=nx>currencyIdentifier</span> <span class=o>+</span> <span class=nx>amountUSDTHex</span><span class=p>)</span>
</span></span><span class=line><span class=cl>	<span class=k>if</span> <span class=nx>err</span> <span class=o>!=</span> <span class=kc>nil</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>		<span class=nx>beego</span><span class=p>.</span><span class=nf>Debug</span><span class=p>(</span><span class=s>&#34;SendTransactionUSDT DecodeString error&#34;</span><span class=p>,</span><span class=nx>err</span><span class=p>)</span>
</span></span><span class=line><span class=cl>		<span class=k>return</span>
</span></span><span class=line><span class=cl>	<span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>	<span class=nx>usdtOut</span><span class=p>,</span> <span class=nx>err</span> <span class=o>:=</span> <span class=nx>txscript</span><span class=p>.</span><span class=nf>NullDataScript</span><span class=p>(</span><span class=nx>op_return</span><span class=p>)</span>
</span></span><span class=line><span class=cl>	<span class=k>if</span> <span class=nx>err</span> <span class=o>!=</span> <span class=kc>nil</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>		<span class=nx>beego</span><span class=p>.</span><span class=nf>Error</span><span class=p>(</span><span class=s>&#34;SendTransactionUSDT txscript.NullDataScript error&#34;</span><span class=p>,</span> <span class=nx>err</span><span class=p>)</span>
</span></span><span class=line><span class=cl>		<span class=k>return</span>
</span></span><span class=line><span class=cl>	<span class=p>}</span>
</span></span><span class=line><span class=cl>	<span class=c1>//fmt.Println(&#34;usdtout:&#34;, hex.EncodeToString(usdtOut))
</span></span></span><span class=line><span class=cl><span class=c1></span>	<span class=nx>usdtOutput</span> <span class=o>:=</span> <span class=nx>wire</span><span class=p>.</span><span class=nf>NewTxOut</span><span class=p>(</span><span class=nb>int64</span><span class=p>(</span><span class=mi>0</span><span class=p>),</span> <span class=nx>usdtOut</span><span class=p>)</span>
</span></span><span class=line><span class=cl>	<span class=nx>tx</span><span class=p>.</span><span class=nf>AddTxOut</span><span class=p>(</span><span class=nx>usdtOutput</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>	<span class=c1>// our change address
</span></span></span><span class=line><span class=cl><span class=c1></span>	<span class=nx>changeSendToAddress</span><span class=p>,</span> <span class=nx>err</span> <span class=o>:=</span> <span class=nx>btcutil</span><span class=p>.</span><span class=nf>DecodeAddress</span><span class=p>(</span><span class=nx>fromWalletPublicAddress</span><span class=p>,</span> <span class=nx>chainParams</span><span class=p>)</span>
</span></span><span class=line><span class=cl>	<span class=k>if</span> <span class=nx>err</span> <span class=o>!=</span> <span class=kc>nil</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>		<span class=nx>beego</span><span class=p>.</span><span class=nf>Error</span><span class=p>(</span><span class=nx>err</span><span class=p>)</span>
</span></span><span class=line><span class=cl>		<span class=k>return</span> <span class=s>&#34;&#34;</span><span class=p>,</span> <span class=nx>err</span>
</span></span><span class=line><span class=cl>	<span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>	<span class=nx>changeSendToScript</span><span class=p>,</span> <span class=nx>err</span> <span class=o>:=</span> <span class=nx>txscript</span><span class=p>.</span><span class=nf>PayToAddrScript</span><span class=p>(</span><span class=nx>changeSendToAddress</span><span class=p>)</span>
</span></span><span class=line><span class=cl>	<span class=k>if</span> <span class=nx>err</span> <span class=o>!=</span> <span class=kc>nil</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>		<span class=nx>beego</span><span class=p>.</span><span class=nf>Error</span><span class=p>(</span><span class=nx>err</span><span class=p>)</span>
</span></span><span class=line><span class=cl>		<span class=k>return</span> <span class=s>&#34;&#34;</span><span class=p>,</span> <span class=nx>err</span>
</span></span><span class=line><span class=cl>	<span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>	<span class=c1>// tx out to send change back to us
</span></span></span><span class=line><span class=cl><span class=c1></span>	<span class=nx>changeOutput</span> <span class=o>:=</span> <span class=nx>wire</span><span class=p>.</span><span class=nf>NewTxOut</span><span class=p>(</span><span class=nx>change</span><span class=p>.</span><span class=nf>Int64</span><span class=p>(),</span> <span class=nx>changeSendToScript</span><span class=p>)</span>
</span></span><span class=line><span class=cl>	<span class=nx>tx</span><span class=p>.</span><span class=nf>AddTxOut</span><span class=p>(</span><span class=nx>changeOutput</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>	<span class=nx>privWif</span> <span class=o>:=</span> <span class=nx>address</span><span class=p>.</span><span class=nx>PrivateKey</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>	<span class=nx>decodedWif</span><span class=p>,</span> <span class=nx>err</span> <span class=o>:=</span> <span class=nx>btcutil</span><span class=p>.</span><span class=nf>DecodeWIF</span><span class=p>(</span><span class=nx>privWif</span><span class=p>)</span>
</span></span><span class=line><span class=cl>	<span class=k>if</span> <span class=nx>err</span> <span class=o>!=</span> <span class=kc>nil</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>		<span class=nx>beego</span><span class=p>.</span><span class=nf>Error</span><span class=p>(</span><span class=nx>err</span><span class=p>)</span>
</span></span><span class=line><span class=cl>		<span class=k>return</span> <span class=s>&#34;&#34;</span><span class=p>,</span> <span class=nx>err</span>
</span></span><span class=line><span class=cl>	<span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>	<span class=nx>addressPubKey</span><span class=p>,</span> <span class=nx>err</span> <span class=o>:=</span> <span class=nx>btcutil</span><span class=p>.</span><span class=nf>NewAddressPubKey</span><span class=p>(</span><span class=nx>decodedWif</span><span class=p>.</span><span class=nx>PrivKey</span><span class=p>.</span><span class=nf>PubKey</span><span class=p>().</span><span class=nf>SerializeCompressed</span><span class=p>(),</span> <span class=nx>chainParams</span><span class=p>)</span>
</span></span><span class=line><span class=cl>	<span class=k>if</span> <span class=nx>err</span> <span class=o>!=</span> <span class=kc>nil</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>		<span class=nx>beego</span><span class=p>.</span><span class=nf>Error</span><span class=p>(</span><span class=nx>err</span><span class=p>)</span>
</span></span><span class=line><span class=cl>		<span class=k>return</span> <span class=s>&#34;&#34;</span><span class=p>,</span> <span class=nx>err</span>
</span></span><span class=line><span class=cl>	<span class=p>}</span>
</span></span><span class=line><span class=cl>	<span class=nx>sourceAddress</span><span class=p>,</span> <span class=nx>err</span> <span class=o>:=</span> <span class=nx>btcutil</span><span class=p>.</span><span class=nf>DecodeAddress</span><span class=p>(</span><span class=nx>addressPubKey</span><span class=p>.</span><span class=nf>EncodeAddress</span><span class=p>(),</span> <span class=nx>chainParams</span><span class=p>)</span>
</span></span><span class=line><span class=cl>	<span class=k>if</span> <span class=nx>err</span> <span class=o>!=</span> <span class=kc>nil</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>		<span class=nx>beego</span><span class=p>.</span><span class=nf>Error</span><span class=p>(</span><span class=nx>err</span><span class=p>)</span>
</span></span><span class=line><span class=cl>		<span class=k>return</span> <span class=s>&#34;&#34;</span><span class=p>,</span> <span class=nx>err</span>
</span></span><span class=line><span class=cl>	<span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>	<span class=nx>fmt</span><span class=p>.</span><span class=nf>Printf</span><span class=p>(</span><span class=s>&#34;Source Address: %s\n&#34;</span><span class=p>,</span> <span class=nx>sourceAddress</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>	<span class=nx>sourcePkScript</span><span class=p>,</span> <span class=nx>err</span> <span class=o>:=</span> <span class=nx>txscript</span><span class=p>.</span><span class=nf>PayToAddrScript</span><span class=p>(</span><span class=nx>sourceAddress</span><span class=p>)</span>
</span></span><span class=line><span class=cl>	<span class=k>if</span> <span class=nx>err</span> <span class=o>!=</span> <span class=kc>nil</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>		<span class=nx>beego</span><span class=p>.</span><span class=nf>Error</span><span class=p>(</span><span class=nx>err</span><span class=p>)</span>
</span></span><span class=line><span class=cl>		<span class=k>return</span> <span class=s>&#34;&#34;</span><span class=p>,</span> <span class=nx>err</span>
</span></span><span class=line><span class=cl>	<span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>	<span class=k>for</span> <span class=nx>i</span> <span class=o>:=</span> <span class=k>range</span> <span class=nx>sourceUTXOs</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>		<span class=nx>fmt</span><span class=p>.</span><span class=nf>Println</span><span class=p>(</span><span class=s>&#34;sourceUTXOs[i]:&#34;</span><span class=p>,</span> <span class=nx>sourceUTXOs</span><span class=p>[</span><span class=nx>i</span><span class=p>])</span>
</span></span><span class=line><span class=cl>		<span class=nx>sigScript</span><span class=p>,</span> <span class=nx>err</span> <span class=o>:=</span> <span class=nx>txscript</span><span class=p>.</span><span class=nf>SignatureScript</span><span class=p>(</span><span class=nx>tx</span><span class=p>,</span> <span class=nx>i</span><span class=p>,</span> <span class=nx>sourcePkScript</span><span class=p>,</span> <span class=nx>txscript</span><span class=p>.</span><span class=nx>SigHashAll</span><span class=p>,</span> <span class=nx>decodedWif</span><span class=p>.</span><span class=nx>PrivKey</span><span class=p>,</span> <span class=kc>true</span><span class=p>)</span>
</span></span><span class=line><span class=cl>		<span class=k>if</span> <span class=nx>err</span> <span class=o>!=</span> <span class=kc>nil</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>			<span class=nx>beego</span><span class=p>.</span><span class=nf>Error</span><span class=p>(</span><span class=nx>err</span><span class=p>)</span>
</span></span><span class=line><span class=cl>			<span class=k>return</span> <span class=s>&#34;&#34;</span><span class=p>,</span> <span class=nx>err</span>
</span></span><span class=line><span class=cl>		<span class=p>}</span>
</span></span><span class=line><span class=cl>		<span class=nx>tx</span><span class=p>.</span><span class=nx>TxIn</span><span class=p>[</span><span class=nx>i</span><span class=p>].</span><span class=nx>SignatureScript</span> <span class=p>=</span> <span class=nx>sigScript</span>
</span></span><span class=line><span class=cl>	<span class=p>}</span>
</span></span><span class=line><span class=cl>	<span class=k>for</span> <span class=nx>_</span><span class=p>,</span> <span class=nx>tx</span> <span class=o>:=</span> <span class=k>range</span> <span class=nx>tx</span><span class=p>.</span><span class=nx>TxIn</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>		<span class=nx>fmt</span><span class=p>.</span><span class=nf>Println</span><span class=p>(</span><span class=s>&#34;TxIn[i]:&#34;</span><span class=p>,</span> <span class=nx>tx</span><span class=p>)</span>
</span></span><span class=line><span class=cl>	<span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>	<span class=nx>buf</span> <span class=o>:=</span> <span class=nx>bytes</span><span class=p>.</span><span class=nf>NewBuffer</span><span class=p>(</span><span class=nb>make</span><span class=p>([]</span><span class=kt>byte</span><span class=p>,</span> <span class=mi>0</span><span class=p>,</span> <span class=nx>tx</span><span class=p>.</span><span class=nf>SerializeSize</span><span class=p>()))</span>
</span></span><span class=line><span class=cl>	<span class=nx>_</span> <span class=p>=</span> <span class=nx>tx</span><span class=p>.</span><span class=nf>Serialize</span><span class=p>(</span><span class=nx>buf</span><span class=p>)</span>
</span></span><span class=line><span class=cl>	<span class=nx>fmt</span><span class=p>.</span><span class=nf>Printf</span><span class=p>(</span><span class=s>&#34;Redeem Tx: %v\n&#34;</span><span class=p>,</span> <span class=nx>hex</span><span class=p>.</span><span class=nf>EncodeToString</span><span class=p>(</span><span class=nx>buf</span><span class=p>.</span><span class=nf>Bytes</span><span class=p>()))</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>	<span class=nx>txHash</span><span class=p>,</span> <span class=nx>err</span> <span class=p>=</span> <span class=nx>btc</span><span class=p>.</span><span class=nf>CastTransaction</span><span class=p>(</span><span class=nx>tx</span><span class=p>)</span>
</span></span><span class=line><span class=cl>	<span class=k>if</span> <span class=nx>err</span> <span class=o>!=</span> <span class=kc>nil</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>		<span class=nx>beego</span><span class=p>.</span><span class=nf>Error</span><span class=p>(</span><span class=nx>err</span><span class=p>)</span>
</span></span><span class=line><span class=cl>		<span class=k>return</span> <span class=s>&#34;&#34;</span><span class=p>,</span> <span class=nx>err</span>
</span></span><span class=line><span class=cl>	<span class=p>}</span>
</span></span><span class=line><span class=cl>	<span class=nx>fmt</span><span class=p>.</span><span class=nf>Printf</span><span class=p>(</span><span class=s>&#34;tx hash: %s\n&#34;</span><span class=p>,</span> <span class=nx>txHash</span><span class=p>)</span>
</span></span><span class=line><span class=cl>	<span class=k>return</span> <span class=nx>txHash</span><span class=p>,</span> <span class=kc>nil</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></div></div><footer class=post-footer><ul class=post-tags><li><a href=https://blog.moyrn.com/tags/golang/>Golang</a></li><li><a href=https://blog.moyrn.com/tags/%E5%8C%BA%E5%9D%97%E9%93%BE/>区块链</a></li></ul><nav class=paginav><a class=prev href=https://blog.moyrn.com/posts/20191029_build/><span class=title>« 上一页</span><br><span>Golang 编译</span>
</a><a class=next href=https://blog.moyrn.com/posts/20190810_gorm/><span class=title>下一页 »</span><br><span>GORM 使用</span></a></nav></footer></article></main><footer class=footer><span>&copy; 2025 <a href=https://blog.moyrn.com/>Moyrne'Blog</a></span> ·
<span>Powered by
<a href=https://gohugo.io/ rel="noopener noreferrer" target=_blank>Hugo</a> &
        <a href=https://github.com/adityatelange/hugo-PaperMod/ rel=noopener target=_blank>PaperMod</a></span></footer><a href=#top aria-label="go to top" title="Go to Top (Alt + G)" class=top-link id=top-link accesskey=g><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 12 6" fill="currentcolor"><path d="M12 6H0l6-6z"/></svg>
</a><script>let menu=document.getElementById("menu");menu&&(menu.scrollLeft=localStorage.getItem("menu-scroll-position"),menu.onscroll=function(){localStorage.setItem("menu-scroll-position",menu.scrollLeft)}),document.querySelectorAll('a[href^="#"]').forEach(e=>{e.addEventListener("click",function(e){e.preventDefault();var t=this.getAttribute("href").substr(1);window.matchMedia("(prefers-reduced-motion: reduce)").matches?document.querySelector(`[id='${decodeURIComponent(t)}']`).scrollIntoView():document.querySelector(`[id='${decodeURIComponent(t)}']`).scrollIntoView({behavior:"smooth"}),t==="top"?history.replaceState(null,null," "):history.pushState(null,null,`#${t}`)})})</script><script>var mybutton=document.getElementById("top-link");window.onscroll=function(){document.body.scrollTop>800||document.documentElement.scrollTop>800?(mybutton.style.visibility="visible",mybutton.style.opacity="1"):(mybutton.style.visibility="hidden",mybutton.style.opacity="0")}</script><script>document.getElementById("theme-toggle").addEventListener("click",()=>{document.body.className.includes("dark")?(document.body.classList.remove("dark"),localStorage.setItem("pref-theme","light")):(document.body.classList.add("dark"),localStorage.setItem("pref-theme","dark"))})</script><script>document.querySelectorAll("pre > code").forEach(e=>{const n=e.parentNode.parentNode,t=document.createElement("button");t.classList.add("copy-code"),t.innerHTML="复制";function s(){t.innerHTML="已复制！",setTimeout(()=>{t.innerHTML="复制"},2e3)}t.addEventListener("click",t=>{if("clipboard"in navigator){navigator.clipboard.writeText(e.textContent),s();return}const n=document.createRange();n.selectNodeContents(e);const o=window.getSelection();o.removeAllRanges(),o.addRange(n);try{document.execCommand("copy"),s()}catch{}o.removeRange(n)}),n.classList.contains("highlight")?n.appendChild(t):n.parentNode.firstChild==n||(e.parentNode.parentNode.parentNode.parentNode.parentNode.nodeName=="TABLE"?e.parentNode.parentNode.parentNode.parentNode.parentNode.appendChild(t):e.parentNode.appendChild(t))})</script></body></html>