<!doctype html><html lang=zh dir=auto><head><meta charset=utf-8><meta http-equiv=X-UA-Compatible content="IE=edge"><meta name=viewport content="width=device-width,initial-scale=1,shrink-to-fit=no"><meta name=robots content="index, follow"><title>安装kubernetes | Moyrne'Blog</title>
<meta name=keywords content="kubernetes"><meta name=description content="安装kubernetes https://segmentfault.com/a/1190000044830019
关闭 selinux sed -ri 's/SELINUX=enforcing/SELINUX=disabled/' /etc/selinux/config setenforce 0 && getenforce cgroupv2 grubby --update-kernel=ALL --args=systemd.unified_cgroup_hierarchy=1 开启 ipforward vi /etc/sysctl.conf net.ipv4.ip_forward = 1 net.bridge.bridge-nf-call-ip6tables = 1 net.bridge.bridge-nf-call-iptables = 1 sysctl --system 停止 firewalld systemctl stop firewalld.service systemctl disable firewalld.service 关闭 swap 分区 swapoff -a && sysctl -w vm.swappiness=0 sed -ri '/^[^#]*swap/s@^@#@' /etc/fstab 安装 ipvsadm yum install ipvsadm ipset sysstat conntrack libseccomp -y modprobe -- ip_vs modprobe -- ip_vs_rr modprobe -- ip_vs_wrr modprobe -- ip_vs_sh modprobe -- nf_conntrack 配置 ipvs."><meta name=author content><link rel=canonical href=https://blog.moyrn.com/posts/20250830_install_k8s/><meta name=msvalidate.01 content="XYZabc"><link crossorigin=anonymous href=/assets/css/stylesheet.a9130754b4e5ef2e27659d427d4412b37b2065a5d0f8c40026be2cd4c2046416.css integrity="sha256-qRMHVLTl7y4nZZ1CfUQSs3sgZaXQ+MQAJr4s1MIEZBY=" rel="preload stylesheet" as=style><link rel=icon href=https://blog.moyrn.com/favicon.ico><link rel=icon type=image/png sizes=16x16 href=https://blog.moyrn.com/favicon.ico><link rel=icon type=image/png sizes=32x32 href=https://blog.moyrn.com/favicon.ico><link rel=apple-touch-icon href=https://blog.moyrn.com/favicon.ico><link rel=mask-icon href=https://blog.moyrn.com/favicon.ico><meta name=theme-color content="#2e2e33"><meta name=msapplication-TileColor content="#2e2e33"><link rel=alternate hreflang=zh href=https://blog.moyrn.com/posts/20250830_install_k8s/><noscript><style>#theme-toggle,.top-link{display:none}</style><style>@media(prefers-color-scheme:dark){:root{--theme:rgb(29, 30, 32);--entry:rgb(46, 46, 51);--primary:rgb(218, 218, 219);--secondary:rgb(155, 156, 157);--tertiary:rgb(65, 66, 68);--content:rgb(196, 196, 197);--code-block-bg:rgb(46, 46, 51);--code-bg:rgb(55, 56, 62);--border:rgb(51, 51, 51)}.list{background:var(--theme)}.list:not(.dark)::-webkit-scrollbar-track{background:0 0}.list:not(.dark)::-webkit-scrollbar-thumb{border-color:var(--theme)}}</style></noscript><meta property="og:url" content="https://blog.moyrn.com/posts/20250830_install_k8s/"><meta property="og:site_name" content="Moyrne'Blog"><meta property="og:title" content="安装kubernetes"><meta property="og:description" content="安装kubernetes https://segmentfault.com/a/1190000044830019
关闭 selinux sed -ri 's/SELINUX=enforcing/SELINUX=disabled/' /etc/selinux/config setenforce 0 && getenforce cgroupv2 grubby --update-kernel=ALL --args=systemd.unified_cgroup_hierarchy=1 开启 ipforward vi /etc/sysctl.conf net.ipv4.ip_forward = 1 net.bridge.bridge-nf-call-ip6tables = 1 net.bridge.bridge-nf-call-iptables = 1 sysctl --system 停止 firewalld systemctl stop firewalld.service systemctl disable firewalld.service 关闭 swap 分区 swapoff -a && sysctl -w vm.swappiness=0 sed -ri '/^[^#]*swap/s@^@#@' /etc/fstab 安装 ipvsadm yum install ipvsadm ipset sysstat conntrack libseccomp -y modprobe -- ip_vs modprobe -- ip_vs_rr modprobe -- ip_vs_wrr modprobe -- ip_vs_sh modprobe -- nf_conntrack 配置 ipvs."><meta property="og:locale" content="zh-CN"><meta property="og:type" content="article"><meta property="article:section" content="posts"><meta property="article:published_time" content="2025-08-30T15:04:45+08:00"><meta property="article:modified_time" content="2025-08-30T15:04:45+08:00"><meta property="article:tag" content="Kubernetes"><meta name=twitter:card content="summary"><meta name=twitter:title content="安装kubernetes"><meta name=twitter:description content="安装kubernetes https://segmentfault.com/a/1190000044830019
关闭 selinux sed -ri 's/SELINUX=enforcing/SELINUX=disabled/' /etc/selinux/config setenforce 0 && getenforce cgroupv2 grubby --update-kernel=ALL --args=systemd.unified_cgroup_hierarchy=1 开启 ipforward vi /etc/sysctl.conf net.ipv4.ip_forward = 1 net.bridge.bridge-nf-call-ip6tables = 1 net.bridge.bridge-nf-call-iptables = 1 sysctl --system 停止 firewalld systemctl stop firewalld.service systemctl disable firewalld.service 关闭 swap 分区 swapoff -a && sysctl -w vm.swappiness=0 sed -ri '/^[^#]*swap/s@^@#@' /etc/fstab 安装 ipvsadm yum install ipvsadm ipset sysstat conntrack libseccomp -y modprobe -- ip_vs modprobe -- ip_vs_rr modprobe -- ip_vs_wrr modprobe -- ip_vs_sh modprobe -- nf_conntrack 配置 ipvs."><script type=application/ld+json>{"@context":"https://schema.org","@type":"BreadcrumbList","itemListElement":[{"@type":"ListItem","position":1,"name":"Posts","item":"https://blog.moyrn.com/posts/"},{"@type":"ListItem","position":2,"name":"安装kubernetes","item":"https://blog.moyrn.com/posts/20250830_install_k8s/"}]}</script><script type=application/ld+json>{"@context":"https://schema.org","@type":"BlogPosting","headline":"安装kubernetes","name":"安装kubernetes","description":"安装kubernetes https://segmentfault.com/a/1190000044830019\n关闭 selinux sed -ri 's/SELINUX=enforcing/SELINUX=disabled/' /etc/selinux/config setenforce 0 \u0026amp;\u0026amp; getenforce cgroupv2 grubby --update-kernel=ALL --args=systemd.unified_cgroup_hierarchy=1 开启 ipforward vi /etc/sysctl.conf net.ipv4.ip_forward = 1 net.bridge.bridge-nf-call-ip6tables = 1 net.bridge.bridge-nf-call-iptables = 1 sysctl --system 停止 firewalld systemctl stop firewalld.service systemctl disable firewalld.service 关闭 swap 分区 swapoff -a \u0026amp;\u0026amp; sysctl -w vm.swappiness=0 sed -ri '/^[^#]*swap/s@^@#@' /etc/fstab 安装 ipvsadm yum install ipvsadm ipset sysstat conntrack libseccomp -y modprobe -- ip_vs modprobe -- ip_vs_rr modprobe -- ip_vs_wrr modprobe -- ip_vs_sh modprobe -- nf_conntrack 配置 ipvs.","keywords":["kubernetes"],"articleBody":"安装kubernetes https://segmentfault.com/a/1190000044830019\n关闭 selinux sed -ri 's/SELINUX=enforcing/SELINUX=disabled/' /etc/selinux/config setenforce 0 \u0026\u0026 getenforce cgroupv2 grubby --update-kernel=ALL --args=systemd.unified_cgroup_hierarchy=1 开启 ipforward vi /etc/sysctl.conf net.ipv4.ip_forward = 1 net.bridge.bridge-nf-call-ip6tables = 1 net.bridge.bridge-nf-call-iptables = 1 sysctl --system 停止 firewalld systemctl stop firewalld.service systemctl disable firewalld.service 关闭 swap 分区 swapoff -a \u0026\u0026 sysctl -w vm.swappiness=0 sed -ri '/^[^#]*swap/s@^@#@' /etc/fstab 安装 ipvsadm yum install ipvsadm ipset sysstat conntrack libseccomp -y modprobe -- ip_vs modprobe -- ip_vs_rr modprobe -- ip_vs_wrr modprobe -- ip_vs_sh modprobe -- nf_conntrack 配置 ipvs.conf, 加入以下内容 vim /etc/modules-load.d/ipvs.conf\nip_vs ip_vs_lc ip_vs_wlc ip_vs_rr ip_vs_wrr ip_vs_lblc ip_vs_lblcr ip_vs_dh ip_vs_sh ip_vs_fo ip_vs_nq ip_vs_sed ip_vs_ftp ip_vs_sh nf_conntrack ip_tables ip_set xt_set ipt_set ipt_rpfilter ipt_REJECT ipip overlay br_netfilter 服务生效 systemctl enable --now systemd-modules-load.service 安装 containerd https://github.com/containerd/containerd/blob/main/docs/getting-started.md\nDownload containerd.tar.gz Download the containerd.tar.gz archive from https://github.com/containerd/containerd/releases , verify its sha256sum, and extract it under /usr/local:\ntar Cxzvf /usr/local containerd-1.6.2-linux-amd64.tar.gz Download containerd.service wget https://raw.githubusercontent.com/containerd/containerd/main/containerd.service -O /usr/lib/systemd/system/containerd.service systemctl daemon-reload systemctl enable --now containerd Installing runc. Download the runc binary from https://github.com/opencontainers/runc/releases , verify its sha256sum, and install it as /usr/local/sbin/runc.\ninstall -m 755 runc.amd64 /usr/local/sbin/runc Installing CNI plugins Download the cni-plugins—.tgz archive from https://github.com/containernetworking/plugins/releases , verify its sha256sum, and extract it under /opt/cni/bin:\nmkdir -p /opt/cni/bin tar Cxzvf /opt/cni/bin cni-plugins-linux-amd64-v1.1.1.tgz Install Kubeadm https://kubernetes.io/zh-cn/docs/setup/production-environment/tools/kubeadm/install-kubeadm\n配置 yum.repo cat \u003c","wordCount":"560","inLanguage":"zh","datePublished":"2025-08-30T15:04:45+08:00","dateModified":"2025-08-30T15:04:45+08:00","mainEntityOfPage":{"@type":"WebPage","@id":"https://blog.moyrn.com/posts/20250830_install_k8s/"},"publisher":{"@type":"Organization","name":"Moyrne'Blog","logo":{"@type":"ImageObject","url":"https://blog.moyrn.com/favicon.ico"}}}</script></head><body id=top><script>localStorage.getItem("pref-theme")==="dark"?document.body.classList.add("dark"):localStorage.getItem("pref-theme")==="light"?document.body.classList.remove("dark"):window.matchMedia("(prefers-color-scheme: dark)").matches&&document.body.classList.add("dark")</script><header class=header><nav class=nav><div class=logo><a href=https://blog.moyrn.com/ accesskey=h title="Home (Alt + H)">Home</a><div class=logo-switches><button id=theme-toggle accesskey=t title="(Alt + T)" aria-label="Toggle theme"><svg id="moon" xmlns="http://www.w3.org/2000/svg" width="24" height="18" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 12.79A9 9 0 1111.21 3 7 7 0 0021 12.79z"/></svg><svg id="sun" xmlns="http://www.w3.org/2000/svg" width="24" height="18" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="5"/><line x1="12" y1="1" x2="12" y2="3"/><line x1="12" y1="21" x2="12" y2="23"/><line x1="4.22" y1="4.22" x2="5.64" y2="5.64"/><line x1="18.36" y1="18.36" x2="19.78" y2="19.78"/><line x1="1" y1="12" x2="3" y2="12"/><line x1="21" y1="12" x2="23" y2="12"/><line x1="4.22" y1="19.78" x2="5.64" y2="18.36"/><line x1="18.36" y1="5.64" x2="19.78" y2="4.22"/></svg></button></div></div><ul id=menu><li><a href=https://blog.moyrn.com/tags/ title=Tags><span>Tags</span></a></li><li><a href=https://blog.moyrn.com/categories/ title=Categories><span>Categories</span></a></li></ul></nav></header><main class=main><article class=post-single><header class=post-header><div class=breadcrumbs><a href=https://blog.moyrn.com/>主页</a>&nbsp;»&nbsp;<a href=https://blog.moyrn.com/posts/>Posts</a></div><h1 class="post-title entry-hint-parent">安装kubernetes</h1><div class=post-meta><span title='2025-08-30 15:04:45 +0800 +0800'>2025-08-30</span>&nbsp;·&nbsp;3 分钟&nbsp;·&nbsp;560 字</div></header><div class=post-content><h1 id=安装kubernetes>安装kubernetes<a hidden class=anchor aria-hidden=true href=#安装kubernetes>#</a></h1><blockquote><p><a href=https://segmentfault.com/a/1190000044830019>https://segmentfault.com/a/1190000044830019</a></p></blockquote><h1 id=关闭-selinux>关闭 selinux<a hidden class=anchor aria-hidden=true href=#关闭-selinux>#</a></h1><pre><code>sed -ri 's/SELINUX=enforcing/SELINUX=disabled/' /etc/selinux/config
setenforce 0 &amp;&amp; getenforce
</code></pre><h1 id=cgroupv2>cgroupv2<a hidden class=anchor aria-hidden=true href=#cgroupv2>#</a></h1><pre><code>grubby --update-kernel=ALL --args=systemd.unified_cgroup_hierarchy=1
</code></pre><h1 id=开启-ipforward>开启 ipforward<a hidden class=anchor aria-hidden=true href=#开启-ipforward>#</a></h1><pre><code>vi /etc/sysctl.conf

net.ipv4.ip_forward = 1
net.bridge.bridge-nf-call-ip6tables = 1
net.bridge.bridge-nf-call-iptables = 1

sysctl --system
</code></pre><h1 id=停止-firewalld>停止 firewalld<a hidden class=anchor aria-hidden=true href=#停止-firewalld>#</a></h1><pre><code>systemctl stop firewalld.service
systemctl disable firewalld.service
</code></pre><h1 id=关闭-swap-分区>关闭 swap 分区<a hidden class=anchor aria-hidden=true href=#关闭-swap-分区>#</a></h1><pre><code>swapoff -a &amp;&amp; sysctl -w vm.swappiness=0
sed -ri '/^[^#]*swap/s@^@#@' /etc/fstab
</code></pre><h1 id=安装-ipvsadm>安装 ipvsadm<a hidden class=anchor aria-hidden=true href=#安装-ipvsadm>#</a></h1><pre><code>yum install ipvsadm ipset sysstat conntrack libseccomp -y
modprobe -- ip_vs
modprobe -- ip_vs_rr
modprobe -- ip_vs_wrr
modprobe -- ip_vs_sh
modprobe -- nf_conntrack
</code></pre><h1 id=配置-ipvsconf-加入以下内容>配置 ipvs.conf, 加入以下内容<a hidden class=anchor aria-hidden=true href=#配置-ipvsconf-加入以下内容>#</a></h1><blockquote><p>vim /etc/modules-load.d/ipvs.conf</p></blockquote><pre><code>ip_vs
ip_vs_lc
ip_vs_wlc
ip_vs_rr
ip_vs_wrr
ip_vs_lblc
ip_vs_lblcr
ip_vs_dh
ip_vs_sh
ip_vs_fo
ip_vs_nq
ip_vs_sed
ip_vs_ftp
ip_vs_sh
nf_conntrack
ip_tables
ip_set
xt_set
ipt_set
ipt_rpfilter
ipt_REJECT
ipip
overlay
br_netfilter
</code></pre><h1 id=服务生效>服务生效<a hidden class=anchor aria-hidden=true href=#服务生效>#</a></h1><pre><code>systemctl enable --now systemd-modules-load.service
</code></pre><h1 id=安装-containerd>安装 containerd<a hidden class=anchor aria-hidden=true href=#安装-containerd>#</a></h1><blockquote><p><a href=https://github.com/containerd/containerd/blob/main/docs/getting-started.md>https://github.com/containerd/containerd/blob/main/docs/getting-started.md</a></p></blockquote><h2 id=download-containerdtargz>Download containerd.tar.gz<a hidden class=anchor aria-hidden=true href=#download-containerdtargz>#</a></h2><p>Download the containerd.tar.gz archive from <a href=https://github.com/containerd/containerd/releases>https://github.com/containerd/containerd/releases</a> , verify its sha256sum, and extract it under /usr/local:</p><pre><code>tar Cxzvf /usr/local containerd-1.6.2-linux-amd64.tar.gz
</code></pre><h2 id=download-containerdservice>Download containerd.service<a hidden class=anchor aria-hidden=true href=#download-containerdservice>#</a></h2><pre><code>wget https://raw.githubusercontent.com/containerd/containerd/main/containerd.service -O /usr/lib/systemd/system/containerd.service
systemctl daemon-reload
systemctl enable --now containerd
</code></pre><h2 id=installing-runc>Installing runc.<a hidden class=anchor aria-hidden=true href=#installing-runc>#</a></h2><p>Download the runc binary from <a href=https://github.com/opencontainers/runc/releases>https://github.com/opencontainers/runc/releases</a> , verify its sha256sum, and install it as /usr/local/sbin/runc.</p><pre><code>install -m 755 runc.amd64 /usr/local/sbin/runc
</code></pre><h1 id=installing-cni-plugins>Installing CNI plugins<a hidden class=anchor aria-hidden=true href=#installing-cni-plugins>#</a></h1><p>Download the cni-plugins&mdash;.tgz archive from <a href=https://github.com/containernetworking/plugins/releases>https://github.com/containernetworking/plugins/releases</a> , verify its sha256sum, and extract it under /opt/cni/bin:</p><pre><code>mkdir -p /opt/cni/bin  
tar Cxzvf /opt/cni/bin cni-plugins-linux-amd64-v1.1.1.tgz
</code></pre><h1 id=install-kubeadm>Install Kubeadm<a hidden class=anchor aria-hidden=true href=#install-kubeadm>#</a></h1><blockquote><p><a href=https://kubernetes.io/zh-cn/docs/setup/production-environment/tools/kubeadm/install-kubeadm>https://kubernetes.io/zh-cn/docs/setup/production-environment/tools/kubeadm/install-kubeadm</a></p></blockquote><h2 id=配置-yumrepo>配置 yum.repo<a hidden class=anchor aria-hidden=true href=#配置-yumrepo>#</a></h2><pre><code>cat &lt;&lt;EOF | sudo tee /etc/yum.repos.d/kubernetes.repo
[kubernetes]
name=Kubernetes
baseurl=https://pkgs.k8s.io/core:/stable:/v1.31/rpm/
enabled=1
gpgcheck=1
gpgkey=https://pkgs.k8s.io/core:/stable:/v1.31/rpm/repodata/repomd.xml.key
exclude=kubelet kubeadm kubectl cri-tools kubernetes-cni
EOF
</code></pre><h2 id=安装-kubeletkubeadm-和-kubectl并启用-kubelet-以确保它在启动时自动启动>安装 kubelet、kubeadm 和 kubectl，并启用 kubelet 以确保它在启动时自动启动:<a hidden class=anchor aria-hidden=true href=#安装-kubeletkubeadm-和-kubectl并启用-kubelet-以确保它在启动时自动启动>#</a></h2><pre><code>sudo yum install -y kubelet kubeadm kubectl --disableexcludes=kubernetes
sudo systemctl enable --now kubelet
</code></pre><h1 id=init-cluster-master>Init Cluster Master<a hidden class=anchor aria-hidden=true href=#init-cluster-master>#</a></h1><h2 id=创建集群>创建集群：<a hidden class=anchor aria-hidden=true href=#创建集群>#</a></h2><pre><code>kubeadm init --config xxx.yaml
</code></pre><p>xxx.yaml:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-yaml data-lang=yaml><span class=line><span class=cl><span class=nt>apiVersion</span><span class=p>:</span><span class=w> </span><span class=l>kubeadm.k8s.io/v1beta3</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>bootstrapTokens</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span>- <span class=nt>groups</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span>- <span class=l>system:bootstrappers:kubeadm:default-node-token</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>token</span><span class=p>:</span><span class=w> </span><span class=l>abcdef.0123456789abcdef</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>ttl</span><span class=p>:</span><span class=w> </span><span class=l>24h0m0s</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>usages</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span>- <span class=l>signing</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span>- <span class=l>authentication</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>kind</span><span class=p>:</span><span class=w> </span><span class=l>InitConfiguration</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>localAPIEndpoint</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>advertiseAddress</span><span class=p>:</span><span class=w> </span><span class=l>xx.xx.xx.xx</span><span class=w> </span><span class=c># master ip</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>bindPort</span><span class=p>:</span><span class=w> </span><span class=m>6443</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>nodeRegistration</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>criSocket</span><span class=p>:</span><span class=w> </span><span class=l>unix:///var/run/containerd/containerd.sock</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>imagePullPolicy</span><span class=p>:</span><span class=w> </span><span class=l>IfNotPresent</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>node1</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>taints</span><span class=p>:</span><span class=w> </span><span class=kc>null</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nn>---</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>apiServer</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>timeoutForControlPlane</span><span class=p>:</span><span class=w> </span><span class=l>4m0s</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>certSANs</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span>- <span class=l>localhost</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span>- <span class=l>node1</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span>- <span class=l>node2</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span>- <span class=l>node3</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>apiVersion</span><span class=p>:</span><span class=w> </span><span class=l>kubeadm.k8s.io/v1beta3</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>certificatesDir</span><span class=p>:</span><span class=w> </span><span class=l>/etc/kubernetes/pki</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>clusterName</span><span class=p>:</span><span class=w> </span><span class=l>kubernetes</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>controllerManager</span><span class=p>:</span><span class=w> </span>{}<span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>dns</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>imageRepository</span><span class=p>:</span><span class=w> </span><span class=l>$proxy/registry.k8s.io/coredns</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>etcd</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>local</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>dataDir</span><span class=p>:</span><span class=w> </span><span class=l>/var/lib/etcd</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>peerCertSANs</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span>- <span class=l>localhost</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span>- <span class=l>node1</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span>- <span class=l>node2</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span>- <span class=l>node3</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>serverCertSANs</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span>- <span class=l>localhost</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span>- <span class=l>node1</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span>- <span class=l>node2</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span>- <span class=l>node3</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>imageRepository</span><span class=p>:</span><span class=w>  </span><span class=l>$proxy/registry.k8s.io</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>kind</span><span class=p>:</span><span class=w> </span><span class=l>ClusterConfiguration</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>kubernetesVersion</span><span class=p>:</span><span class=w> </span><span class=m>1.30.0</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>networking</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>dnsDomain</span><span class=p>:</span><span class=w> </span><span class=l>cluster.local</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>serviceSubnet</span><span class=p>:</span><span class=w> </span><span class=m>10.96.0.0</span><span class=l>/12</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>scheduler</span><span class=p>:</span><span class=w> </span>{}<span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>controlPlaneEndpoint</span><span class=p>:</span><span class=w> </span><span class=l>kubemaster</span><span class=w>
</span></span></span></code></pre></div><h2 id=join-cluster>Join Cluster<a hidden class=anchor aria-hidden=true href=#join-cluster>#</a></h2><p>在其他节点上执行</p><pre><code>kubeadm join kubemaster:6443 --token xxxxxxxxxxxxxxxxxx --discovery-token-ca-cert-hash sha256:xxxxxxxxxxxxxxxxxxx --control-plane --certificate-key xxxxxxxxxxxxxxxx
etcdctl --cacert=&quot;ca.crt&quot; --cert=&quot;healthcheck-client.crt&quot; --key=&quot;healthcheck-client.key&quot; member promote etdcd_memberid
</code></pre><p>如果token过期了，可以使用以下命令行</p><pre><code># 获得 certificate key
kubeadm init phase upload-certs --upload-certs
# 获得 --token 和 discovery-token-ca-cert-hash
kubeadm token create --print-join-command
</code></pre><p>如果发现 etcd、apiserver 这些容器频繁收到退出信号，可能需要排查一下 /etc/containerd/config.toml，是否有设置</p><pre><code>SystemdCgroup = true

# 本地仓库配置 /etc/containerd/config.toml，假设域名是 xx.xx.com，我这里使用的镜像仓库是 harbor
  [plugins.&quot;io.containerd.grpc.v1.cri&quot;.registry.mirrors]
    [plugins.&quot;io.containerd.grpc.v1.cri&quot;.registry.mirrors.&quot;xx.xx.com&quot;]
      endpoint = [&quot;https://xx.xx.com&quot;]
    [plugins.&quot;io.containerd.grpc.v1.cri&quot;.registry.mirrors.&quot;docker.io&quot;]
      endpoint = [&quot;https://xx.xx.com/v2/docker.io&quot;]
    [plugins.&quot;io.containerd.grpc.v1.cri&quot;.registry.mirrors.&quot;quay.io&quot;]
      endpoint = [&quot;https://xx.xx.com/v2/quay.io&quot;]
    [plugins.&quot;io.containerd.grpc.v1.cri&quot;.registry.mirrors.&quot;registry.k8s.io&quot;]
      endpoint = [&quot;https://xx.xx.com/v2/registry.k8s.io&quot;]
</code></pre><p>有时候会需要拷贝</p><pre><code>/etc/cni/net.d/10-calico.conflist
</code></pre><h2 id=安装-calico>安装 Calico<a hidden class=anchor aria-hidden=true href=#安装-calico>#</a></h2><pre><code>curl https://docs.projectcalico.org/v3.7/manifests/calico.yaml
</code></pre><p>如果出现了apply CRD时报错内容过大，可以使用</p><pre><code>kubectl replace --force -f 
</code></pre><p>如果有私有镜像仓库，需要修改image路径</p><pre><code>kubectl apply -f calico.yaml
</code></pre><h2 id=安装-ingress>安装 ingress<a hidden class=anchor aria-hidden=true href=#安装-ingress>#</a></h2><pre><code>kubectl apply -f https://raw.githubusercontent.com/kubernetes/ingress-nginx/refs/heads/release-1.11/deploy/static/provider/cloud/deploy.yaml
</code></pre><p>查看 controller 所在的主机，后续添加映射时在/etc/hosts中添加域名->controller的映射</p><pre><code>kubectl -n ingress-nginx get pods -o wide
NAME                                        READY   STATUS      RESTARTS   AGE   IP             NODE   NOMINATED NODE   READINESS GATES
ingress-nginx-admission-create-xd4tb        0/1     Completed   0          87m   10.1.219.48    k8s3   &lt;none&gt;           &lt;none&gt;
ingress-nginx-admission-patch-xxbhk         0/1     Completed   0          87m   10.1.166.235   k8s1   &lt;none&gt;           &lt;none&gt;
ingress-nginx-controller-775fcf4864-w5htg   1/1     Running     0          87m   10.1.219.49    k8s3   &lt;none&gt;           &lt;none&gt;
</code></pre><p>查看Loadbalancer的端口，80:32100，后续访问 http 时，直接访问 controller 宿主机的 32100 端口</p><pre><code>kubectl -n ingress-nginx get service
NAME                                 TYPE           CLUSTER-IP      EXTERNAL-IP   PORT(S)                      AGE
ingress-nginx-controller             LoadBalancer   10.99.42.227    &lt;pending&gt;     80:32100/TCP,443:31476/TCP   88m
ingress-nginx-controller-admission   ClusterIP      10.96.161.135   &lt;none&gt;        443/TCP                      88m
</code></pre><h2 id=安装-longhorn>安装 Longhorn<a hidden class=anchor aria-hidden=true href=#安装-longhorn>#</a></h2><pre><code>vi /etc/modules-load.d/iscsi.conf

iscsi_tcp

modprobe iscsi_tcp

wget https://raw.githubusercontent.com/longhorn/longhorn/v1.7.x/deploy/longhorn.yaml
</code></pre><p>替换 image: longhornio/ 为 /longhornio/
替换 command 中的 longhornio/ 为 /longhornio/</p><h2 id=安装-prometheus-和-grafana>安装 Prometheus 和 Grafana<a hidden class=anchor aria-hidden=true href=#安装-prometheus-和-grafana>#</a></h2><blockquote><p><a href=https://github.com/prometheus-operator/kube-prometheus/tree/release-0.14/manifests>https://github.com/prometheus-operator/kube-prometheus/tree/release-0.14/manifests</a></p></blockquote><pre><code>kubectl apply -f manifests/setup -f manifests
</code></pre><p>如果需要配置多个节点都能访问 grafana，那么需要处理 NetworkPolicy，我这里直接删除了</p><pre><code>kubectl delete -f kube-prometheus/manifests/grafana-networkPolicy.yaml
</code></pre><p>UUID=936318b2-3bce-4780-bfcb-4c8786c92003 /var/lib/etcd ext4 defaults 1 2
UUID=0d9c79bd-4538-41ff-8944-71ce0bf6c413 /mnt/vdc1 ext4 defaults 1 2</p></div><footer class=post-footer><ul class=post-tags><li><a href=https://blog.moyrn.com/tags/kubernetes/>Kubernetes</a></li></ul><nav class=paginav><a class=next href=https://blog.moyrn.com/posts/20250713_learn_linux/><span class=title>下一页 »</span><br><span>学习Linux-01启动</span></a></nav></footer></article></main><footer class=footer><span>&copy; 2025 <a href=https://blog.moyrn.com/>Moyrne'Blog</a></span> ·
<span>Powered by
<a href=https://gohugo.io/ rel="noopener noreferrer" target=_blank>Hugo</a> &
        <a href=https://github.com/adityatelange/hugo-PaperMod/ rel=noopener target=_blank>PaperMod</a></span></footer><a href=#top aria-label="go to top" title="Go to Top (Alt + G)" class=top-link id=top-link accesskey=g><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 12 6" fill="currentcolor"><path d="M12 6H0l6-6z"/></svg>
</a><script>let menu=document.getElementById("menu");menu&&(menu.scrollLeft=localStorage.getItem("menu-scroll-position"),menu.onscroll=function(){localStorage.setItem("menu-scroll-position",menu.scrollLeft)}),document.querySelectorAll('a[href^="#"]').forEach(e=>{e.addEventListener("click",function(e){e.preventDefault();var t=this.getAttribute("href").substr(1);window.matchMedia("(prefers-reduced-motion: reduce)").matches?document.querySelector(`[id='${decodeURIComponent(t)}']`).scrollIntoView():document.querySelector(`[id='${decodeURIComponent(t)}']`).scrollIntoView({behavior:"smooth"}),t==="top"?history.replaceState(null,null," "):history.pushState(null,null,`#${t}`)})})</script><script>var mybutton=document.getElementById("top-link");window.onscroll=function(){document.body.scrollTop>800||document.documentElement.scrollTop>800?(mybutton.style.visibility="visible",mybutton.style.opacity="1"):(mybutton.style.visibility="hidden",mybutton.style.opacity="0")}</script><script>document.getElementById("theme-toggle").addEventListener("click",()=>{document.body.className.includes("dark")?(document.body.classList.remove("dark"),localStorage.setItem("pref-theme","light")):(document.body.classList.add("dark"),localStorage.setItem("pref-theme","dark"))})</script><script>document.querySelectorAll("pre > code").forEach(e=>{const n=e.parentNode.parentNode,t=document.createElement("button");t.classList.add("copy-code"),t.innerHTML="复制";function s(){t.innerHTML="已复制！",setTimeout(()=>{t.innerHTML="复制"},2e3)}t.addEventListener("click",t=>{if("clipboard"in navigator){navigator.clipboard.writeText(e.textContent),s();return}const n=document.createRange();n.selectNodeContents(e);const o=window.getSelection();o.removeAllRanges(),o.addRange(n);try{document.execCommand("copy"),s()}catch{}o.removeRange(n)}),n.classList.contains("highlight")?n.appendChild(t):n.parentNode.firstChild==n||(e.parentNode.parentNode.parentNode.parentNode.parentNode.nodeName=="TABLE"?e.parentNode.parentNode.parentNode.parentNode.parentNode.appendChild(t):e.parentNode.appendChild(t))})</script></body></html>